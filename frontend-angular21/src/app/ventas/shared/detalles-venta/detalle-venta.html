<div class="p-2">
  <p-card styleClass="ventas-header-card mb-4 ventas-header-bordered">
    <div class="flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="flex align-items-center gap-3">
        <span class="ventas-title-icon">
          <i [class]="iconoCabecera"></i>
        </span>
        <div>
          <p class="ventas-kicker mb-0">{{ tituloKicker }}</p>
          <h2 class="ventas-title mb-0">{{ subtituloKicker }}</h2>
        </div>
      </div>
      <div class="flex gap-3">
        <p-button
          type="button"
          label="Historial Ventas"
          icon="pi pi-list"
          (click)="irHistorialVentas()"
          pTooltip="Ir al historial completo"
          tooltipPosition="bottom"
        />
        <p-button
          type="button"
          label="Imprimir"
          icon="pi pi-print"
          class="p-button-outlined"
          (click)="imprimirComprobante()"
          pTooltip="Imprimir comprobante"
          tooltipPosition="bottom"
        />
      </div>
    </div>
  </p-card>
</div>

<!-- ── SKELETON ─────────────────────────────────────────────────────────── -->
<div *ngIf="loading()" class="p-2">
  <div class="loading-container">
    <p-card>
      <div class="skeleton-wrapper">
        <p-skeleton width="100%" height="150px" styleClass="mb-3"></p-skeleton>
        <p-skeleton width="100%" height="300px" styleClass="mb-3"></p-skeleton>
        <p-skeleton width="100%" height="200px"></p-skeleton>
      </div>
    </p-card>
  </div>
</div>

<!-- ── CONTENIDO ────────────────────────────────────────────────────────── -->
<div *ngIf="!loading() && comprobante()">

  <!-- ── CABECERA COMPROBANTE ─────────────────────────────────────────── -->
  <div class="p-2">
    <p-card class="comprobante-card mb-4">

      <div class="comprobante-header">
        <div class="comprobante-tipo">
          <span class="tipo-icon">
            <i [class]="tipoIcon()"></i>
          </span>
          <div>
            <h2>{{ tipoLabel() }} ELECTRÓNICA</h2>
            <p class="serie-numero">{{ numeroFormateado() }}</p>
          </div>
        </div>
        <div class="comprobante-estado">
          <p-tag
            [value]="estadoLabel()"
            [severity]="estadoSeverity()"
            [rounded]="true"
          ></p-tag>
        </div>
      </div>

      <div class="info-grid-wrapper">
        <div class="info-grid">

          <!-- Cliente -->
          <div class="info-section">
            <h3><i class="pi pi-user"></i> Cliente</h3>
            <div class="info-row">
              <span class="label">Nombre completo:</span>
              <span class="value">{{ comprobante()!.cliente_nombre }}</span>
            </div>
            <div class="info-row">
              <span class="label">Tipo documento:</span>
              <span class="value">{{ comprobante()!.cliente_tipo_doc }}</span>
            </div>
            <div class="info-row">
              <span class="label">N° Documento:</span>
              <span class="value">{{ comprobante()!.cliente_doc }}</span>
            </div>
            <div class="info-row" *ngIf="comprobante()!.cliente_direccion !== '—'">
              <span class="label">Dirección:</span>
              <span class="value">{{ comprobante()!.cliente_direccion }}</span>
            </div>
            <div class="info-row" *ngIf="comprobante()!.cliente_email !== '—'">
              <span class="label">Email:</span>
              <span class="value">{{ comprobante()!.cliente_email }}</span>
            </div>
            <div class="info-row" *ngIf="comprobante()!.cliente_telefono !== '—'">
              <span class="label">Teléfono:</span>
              <span class="value">{{ comprobante()!.cliente_telefono }}</span>
            </div>
          </div>

          <!-- Comprobante -->
          <div class="info-section">
            <h3><i class="pi pi-file-edit"></i> Comprobante</h3>
            <div class="info-row">
              <span class="label">Fecha emisión:</span>
              <span class="value">{{ comprobante()!.fec_emision | date: 'dd/MM/yyyy HH:mm' }}</span>
            </div>
            <div class="info-row" *ngIf="comprobante()!.fec_venc">
              <span class="label">Fecha vencimiento:</span>
              <span class="value">{{ comprobante()!.fec_venc | date: 'dd/MM/yyyy' }}</span>
            </div>
            <div class="info-row">
              <span class="label">Moneda:</span>
              <span class="value">
                {{ comprobante()!.moneda === 'PEN' ? 'Soles (S/.)' : 'Dólares ($)' }}
              </span>
            </div>
            <div class="info-row">
              <span class="label">Responsable:</span>
              <span class="value">{{ comprobante()!.responsable }}</span>
            </div>
            <div class="info-row">
              <span class="label">Sede:</span>
              <span class="value">{{ comprobante()!.sede_nombre }}</span>
            </div>
            <div class="info-row">
              <span class="label">Estado SUNAT:</span>
              <span class="value sunat-ok">{{ comprobante()!.estadoLabel }}</span>
            </div>
          </div>

          <!-- Pago -->
          <div class="info-section">
            <h3><i class="pi pi-wallet"></i> Información de Pago</h3>

            <div *ngIf="comprobante()!.medio_pago !== 'N/A'; else sinPago">
              <div class="pago-item">
                <div class="info-row">
                  <span class="label">Medio de pago:</span>
                  <span class="value">
                    <i [class]="getIconoPago(comprobante()!.medio_pago)"></i>
                    {{ comprobante()!.medio_pago }}
                  </span>
                </div>
                <div class="info-row">
                  <span class="label">Monto pagado:</span>
                  <span class="value amount">S/. {{ comprobante()!.total | number: '1.2-2' }}</span>
                </div>
              </div>
            </div>

            <ng-template #sinPago>
              <div class="no-data">
                <i class="pi pi-info-circle"></i>
                <span>Sin información de pago</span>
              </div>
            </ng-template>
          </div>

        </div>
      </div>
    </p-card>
  </div>

  <!-- ── PRODUCTOS ────────────────────────────────────────────────────── -->
  <div class="p-2">
    <p-card class="productos-card mb-4">
      <ng-template pTemplate="header">
        <div class="card-header">
          <h3>
            <span class="icon-shopping"><i class="pi pi-shopping-cart"></i></span>
            Productos Vendidos
          </h3>
          <p-tag
            [value]="comprobante()!.detalles.length + ' items'"
            severity="success"
            [rounded]="true"
          ></p-tag>
        </div>
      </ng-template>

      <p-table
        [value]="comprobante()!.detalles"
        [paginator]="false"
        [tableStyle]="{ 'min-width': '50rem' }"
        styleClass="p-datatable-gridlines p-datatable-sm"
      >
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 10%">Código</th>
            <th style="width: 40%">Descripción</th>
            <th style="width: 10%; text-align: center">Cantidad</th>
            <th style="width: 13%; text-align: right">Valor Unit.</th>
            <th style="width: 13%; text-align: right">P. Unit.</th>
            <th style="width: 14%; text-align: right">Total</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <td><span class="codigo-producto">{{ item.cod_prod }}</span></td>
            <td><strong>{{ item.descripcion }}</strong></td>
            <td style="text-align: center">{{ item.cantidad }}</td>
            <td style="text-align: right">S/. {{ item.valor_unit | number: '1.2-2' }}</td>
            <td style="text-align: right">S/. {{ item.pre_uni | number: '1.2-2' }}</td>
            <td style="text-align: right">
              <strong>S/. {{ item.total | number: '1.2-2' }}</strong>
            </td>
          </tr>
        </ng-template>
      </p-table>

      <div class="totales-container">
        <div class="totales-grid">
          <div class="total-row">
            <span class="label">Subtotal (Base imponible):</span>
            <span class="value">S/. {{ comprobante()!.subtotal | number: '1.2-2' }}</span>
          </div>
          <div class="total-row">
            <span class="label">IGV (18%):</span>
            <span class="value">S/. {{ comprobante()!.igv | number: '1.2-2' }}</span>
          </div>
          <div class="total-row" *ngIf="comprobante()!.isc > 0">
            <span class="label">ISC:</span>
            <span class="value">S/. {{ comprobante()!.isc | number: '1.2-2' }}</span>
          </div>
          <div class="total-row total-final">
            <span class="label">TOTAL A PAGAR:</span>
            <span class="value">S/. {{ comprobante()!.total | number: '1.2-2' }}</span>
          </div>
        </div>
      </div>
    </p-card>
  </div>

  <!-- ── HISTORIAL CLIENTE ─────────────────────────────────────────────── -->
  <div class="p-2">
    <p-card class="historial-card">
      <ng-template pTemplate="header">
        <div class="card-header">
          <h3>
            <span class="icon-history"><i class="pi pi-history"></i></span>
            Historial de Compras del Cliente
          </h3>
        </div>
      </ng-template>

      <!-- Estadísticas -->
      <div class="estadisticas-cliente">
        <div class="stat-card">
          <i class="pi pi-shopping-bag"></i>
          <div class="stat-content">
            <span class="stat-value">{{ estadisticas()?.totalCompras ?? historial().length }}</span>
            <span class="stat-label">Compras realizadas</span>
          </div>
        </div>
        <div class="stat-card">
          <i class="pi pi-dollar"></i>
          <div class="stat-content">
            <span class="stat-value">
              S/. {{ (estadisticas()?.montoTotal ?? totalHistorial()) | number: '1.2-2' }}
            </span>
            <span class="stat-label">Total gastado</span>
          </div>
        </div>
        <div class="stat-card">
          <i class="pi pi-chart-bar"></i>
          <div class="stat-content">
            <span class="stat-value">
              S/. {{ (estadisticas()?.promedioCompra ?? 0) | number: '1.2-2' }}
            </span>
            <span class="stat-label">Promedio por compra</span>
          </div>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Tabla historial -->
      <div *ngIf="historial().length > 0; else sinHistorial">
        <p-table
          [value]="historial()"
          [paginator]="true"
          [rows]="5"
          [tableStyle]="{ 'min-width': '50rem' }"
          styleClass="p-datatable-gridlines p-datatable-sm"
        >
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 15%">Comprobante</th>
              <th style="width: 12%">Fecha</th>
              <th style="width: 20%">Responsable</th>
              <th style="width: 10%; text-align: center">Tipo</th>
              <th style="width: 10%; text-align: center">Estado</th>
              <th style="width: 13%; text-align: right">Total</th>
              <th style="width: 20%; text-align: center">Acciones</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-venta>
            <tr>
              <td>{{ formatNumero(venta.serie, venta.numero) }}</td>
              <td>{{ venta.fec_emision | date: 'dd/MM/yyyy' }}</td>
              <td>
                <div class="responsable-cell">
                  <i class="pi pi-user"></i>
                  <span>{{ venta.responsable }}</span>
                </div>
              </td>
              <td style="text-align: center">
                <p-tag
                  [value]="getTipoLabel(venta.tipo_comprobante)"
                  [severity]="venta.tipo_comprobante === '03' ? 'info' : 'warn'"
                ></p-tag>
              </td>
              <td style="text-align: center">
                <p-tag
                  [value]="venta.estado"
                  [severity]="getSeverityEstadoHistorial(venta.estado)"
                ></p-tag>
              </td>
              <td style="text-align: right">
                <strong>S/. {{ venta.total | number: '1.2-2' }}</strong>
              </td>
              <td style="text-align: center">
                <div class="flex gap-1 justify-content-center align-items-center">
                  <p-button
                    type="button"
                    icon="pi pi-eye"
                    [text]="true"
                    severity="secondary"
                    (click)="verDetalleHistorial(venta.id)"
                    pTooltip="Ver detalle"
                    tooltipPosition="top"
                    styleClass="icon-btn"
                  />
                  <p-button
                    type="button"
                    icon="pi pi-print"
                    [text]="true"
                    severity="secondary"
                    (click)="imprimirDesdeHistorial(venta)"
                    pTooltip="Imprimir"
                    tooltipPosition="top"
                    styleClass="icon-btn"
                  />
                  <p-button
                    type="button"
                    icon="pi pi-send"
                    [text]="true"
                    severity="secondary"
                    (click)="enviarEmailHistorial(venta)"
                    pTooltip="Enviar por correo"
                    tooltipPosition="top"
                    [disabled]="comprobante()!.cliente_email === '—'"
                    styleClass="icon-btn"
                  />
                </div>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="7" style="text-align: center">
                <div class="no-data">
                  <i class="pi pi-inbox"></i>
                  <p>No hay historial de compras</p>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <ng-template #sinHistorial>
        <div class="no-data">
          <i class="pi pi-info-circle"></i>
          <span>Este cliente no tiene compras anteriores</span>
        </div>
      </ng-template>

    </p-card>
  </div>

</div>

<p-toast></p-toast>