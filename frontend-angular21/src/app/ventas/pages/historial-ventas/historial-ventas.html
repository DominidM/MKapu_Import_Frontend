<div class="p-2">
  <p-card class="ventas-header-card mb-4 ventas-header-bordered">
    <div class="flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="flex align-items-center gap-3">
        <span class="ventas-title-icon">
          <i [class]="iconoCabecera"></i>
        </span>
        <div>
          <p class="ventas-kicker mb-0">{{ tituloKicker }}</p>
          <h2 class="ventas-title mb-0">{{ subtituloKicker }}</h2>
        </div>
      </div>
      <div class="flex gap-2">
        <p-button
          label="Nueva Venta"
          icon="pi pi-plus"
          (onClick)="nuevaVenta()"
          tooltipPosition="bottom"
          pTooltip="Generar Nueva Venta"
        />
      </div>
    </div>
  </p-card>
</div>

<div class="p-2">
  <div class="ventas-header-bordered mb-4">
    <div class="seccion-estadisticas">
      <div class="estadistica-card">
        <i class="pi pi-chart-line"></i>
        <div>
          <span class="estadistica-label">Total Ventas</span>
          <span class="estadistica-valor">S/. {{ totalVentas | number: '1.2-2' }}</span>
        </div>
      </div>

      <div class="estadistica-card">
        <i class="pi pi-shopping-cart"></i>
        <div>
          <span class="estadistica-label">Cantidad de Ventas</span>
          <span class="estadistica-valor">{{ numeroVentas }}</span>
        </div>
      </div>

      <div class="estadistica-card">
        <i class="pi pi-file"></i>
        <div>
          <span class="estadistica-label">Boletas</span>
          <span class="estadistica-valor">{{ totalBoletas }}</span>
        </div>
      </div>

      <div class="estadistica-card">
        <i class="pi pi-file-edit"></i>
        <div>
          <span class="estadistica-label">Facturas</span>
          <span class="estadistica-valor">{{ totalFacturas }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="p-2">
  <div class="filtros-container mb-4">
    <div class="seccion-filtros">
      <h3><i class="pi pi-filter"></i> Filtros de búsqueda</h3>

      <div class="filtros-linea-1">
        <div class="filtro-item filtro-cliente-50">
          <label>Cliente (DNI/RUC)</label>
          <p-autocomplete
            [(ngModel)]="filtros.busqueda"
            [suggestions]="sugerenciasBusqueda"
            (completeMethod)="buscarSugerencias($event)"
            (onSelect)="aplicarFiltros()"
            (onClear)="aplicarFiltros()"
            placeholder="Buscar por DNI o RUC"
            [dropdown]="true"
            [showClear]="true"
            styleClass="w-full"
          >
          </p-autocomplete>
        </div>

        <div class="filtro-item filtro-grupo-fechas">
          <label>Rango de Fechas</label>
          <div class="fechas-con-guion">
            <p-datepicker
              [(ngModel)]="filtros.fechaInicio"
              dateFormat="dd/mm/yy"
              placeholder="Fecha Inicio"
              (onSelect)="aplicarFiltros()"
              (onClear)="aplicarFiltros()"
              [showClear]="true"
              [showIcon]="true"
            >
            </p-datepicker>

            <span class="fecha-separador">-</span>

            <p-datepicker
              [(ngModel)]="filtros.fechaFin"
              dateFormat="dd/mm/yy"
              placeholder="Fecha Fin"
              (onSelect)="aplicarFiltros()"
              (onClear)="aplicarFiltros()"
              [showClear]="true"
              [showIcon]="true"
            >
            </p-datepicker>
          </div>
        </div>
      </div>

      <div class="filtros-linea-2">
        <div class="filtro-item filtro-compacto">
          <label>Tipo</label>
          <p-select
            [(ngModel)]="filtros.tipoComprobante"
            [options]="tiposComprobante"
            placeholder="Todos"
            optionLabel="label"
            optionValue="value"
            (onChange)="aplicarFiltros()"
            styleClass="w-full"
          >
          </p-select>
        </div>
        <div class="filtro-item filtro-compacto">
          <label>Tipo de Pago</label>
          <p-select
            [(ngModel)]="filtros.tipoPago"
            [options]="tiposPago"
            placeholder="Todos"
            optionLabel="label"
            optionValue="value"
            (onChange)="aplicarFiltros()"
            styleClass="w-full"
          >
          </p-select>
        </div>
        <div class="filtro-item filtro-compacto">
          <label>Estado</label>
          <p-select
            [(ngModel)]="filtros.estado"
            [options]="estadosComprobante"
            placeholder="Todos"
            optionLabel="label"
            optionValue="value"
            (onChange)="aplicarFiltros()"
            styleClass="w-full"
          >
          </p-select>
        </div>

        <div class="filtro-item filtro-boton-limpiar">
          <label>&nbsp;</label>
          <p-button
            label="Limpiar Filtros"
            icon="pi pi-filter-slash"
            (onClick)="limpiarFiltros()"
            severity="danger"
            styleClass="btn-limpiar-filtros"
          >
          </p-button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="p-2">
  <p-card class="tarjeta-principal">
    <div class="seccion-tabla">
      <div class="tabla-header">
        <h3><i class="pi pi-list"></i> Listado de comprobantes</h3>
      </div>

      <p-table
        [value]="comprobantesFiltrados"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[10, 25, 50, 100]"
        [loading]="loading"
        [tableStyle]="{ 'min-width': '70rem' }"
        styleClass="p-datatable-striped"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
        [showCurrentPageReport]="true"
        paginatorTemplate="CurrentPageReport FirstPageLink PrevPageLink PageLinks NextPageLink LastPageLink RowsPerPageDropdown"
      >
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="numero">N° Comprobante <p-sortIcon field="numero" /></th>
            <th pSortableColumn="tipo_comprobante">Tipo <p-sortIcon field="tipo_comprobante" /></th>
            <th pSortableColumn="fec_emision">Fecha Emisión <p-sortIcon field="fec_emision" /></th>
            <th pSortableColumn="cliente_nombre">Cliente</th>
            <th pSortableColumn="cliente_doc">Documento</th>
            <th pSortableColumn="tipo_pago">Tipo Pago <p-sortIcon field="tipo_pago" /></th>
            <th pSortableColumn="responsable" class="text-right" style="min-width: 155px; width: 140px">
              Responsable <p-sortIcon field="responsable" />
            </th>
            <th pSortableColumn="total" class="text-right">Total <p-sortIcon field="total" /></th>
            <th>Estado</th>
            <th class="text-center">Acciones</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-comprobante>
          <tr>
            <td>
              <strong>{{ getNumeroFormateado(comprobante) }}</strong>
            </td>
            <td>
              <p-tag
                [value]="getTipoComprobanteLabel(comprobante.tipo_comprobante)"
                [severity]="comprobante.tipo_comprobante === '03' ? 'info' : 'warn'"
              ></p-tag>
            </td>
            <td>{{ comprobante.fec_emision | date: 'dd/MM/yyyy HH:mm' }}</td>
            <td>{{ comprobante.cliente_nombre }}</td>
            <td>{{ comprobante.cliente_doc }}</td>

            <td>
              <div class="tipo-pago-cell">
                <p-tag
                  [value]="getTipoPagoLabel(comprobante.tipo_pago)"
                  [severity]="getSeverityTipoPago(comprobante.tipo_pago)"
                  styleClass="tipo-pago-tag"
                ></p-tag>
              </div>
            </td>
            <td>
              <span class="responsable-text">{{ comprobante.responsable }}</span>
            </td>
            <td class="text-right">
              <strong>S/. {{ comprobante.total | number: '1.2-2' }}</strong>
            </td>
            <td>
              <p-tag
                [value]="getEstadoComprobante(comprobante)"
                [severity]="getSeverityEstado(getEstadoComprobante(comprobante))"
              ></p-tag>
            </td>
            <td class="text-center">
              <div class="acciones-tabla">
                <p-button
                  icon="pi pi-eye"
                  (onClick)="verDetalleVenta(comprobante)"
                  [rounded]="true"
                  [text]="true"
                  severity="secondary"
                  pTooltip="Ver detalle"
                  tooltipPosition="top"
                ></p-button>
                <p-button
                  icon="pi pi-print"
                  (onClick)="imprimirComprobante(comprobante)"
                  [rounded]="true"
                  [text]="true"
                  severity="secondary"
                  pTooltip="Imprimir"
                  tooltipPosition="top"
                ></p-button>
                <p-button
                  icon="pi pi-trash"
                  (onClick)="anularComprobante(comprobante)"
                  [rounded]="true"
                  [text]="true"
                  severity="danger"
                  [disabled]="!comprobante.estado"
                  pTooltip="Anular"
                  tooltipPosition="top"
                ></p-button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="10" class="text-center">
              <div class="mensaje-vacio">
                <i class="pi pi-inbox"></i>
                <p>No se encontraron comprobantes</p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </p-card>

  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>
</div>
