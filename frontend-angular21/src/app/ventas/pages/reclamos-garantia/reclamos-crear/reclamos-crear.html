<div class="p-2">
  <p-card styleClass="ventas-header-card mb-4 ventas-header-bordered">
    <div class="flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="flex align-items-center gap-3">
        <span class="ventas-title-icon">
          <i [class]="iconoCabecera"></i>
        </span>
        <div>
          <p class="ventas-kicker mb-0">{{ tituloKicker }}</p>
          <h2 class="ventas-title mb-0">{{ subtituloKicker }}</h2>
        </div>
      </div>
      <div class="flex gap-2">
        <p-button
          label="Ver Listado"
          icon="pi pi-list"
          [outlined]="true"
          severity="secondary"
          styleClass="ventas-pill"
          (onClick)="cancelar()"
        />
        <p-button
          label="Limpiar"
          icon="pi pi-refresh"
          styleClass="ventas-pill"
          (onClick)="limpiarFormulario()"
          [disabled]="reclamoGenerado !== null"
        />
      </div>
    </div>
  </p-card>
</div>

<div class="p-2">
  <p-card styleClass="wizard-card">

    <div class="wizard-steps">
      <div
        *ngFor="let step of steps; let i = index"
        class="wizard-step"
        [class.active]="activeStep === i"
        [class.completed]="activeStep > i"
      >
        <div class="step-number">
          <i *ngIf="activeStep > i" class="pi pi-check"></i>
          <span *ngIf="activeStep <= i">{{ i + 1 }}</span>
        </div>
        <div class="step-title">{{ step }}</div>
      </div>
    </div>

    <p-divider styleClass="wizard-divider" />

    <div class="wizard-content">

      <div *ngIf="activeStep === 0" class="step-content">
        <div class="step-header">
          <i class="pi pi-search step-icon"></i>
          <h3>Buscar Cliente</h3>
        </div>

        <div class="content-centrado">

          <div class="comprobante-section">
            <label class="section-label">
              <i class="pi pi-id-card"></i>
              Tipo de Documento
            </label>
            <div class="flex justify-content-center">
              <p-selectButton
                [(ngModel)]="tipoDocumento"
                [options]="tipoDocumentoOptions"
                optionLabel="label"
                optionValue="value"
                styleClass="select-comprobante-inline"
                (onChange)="onTipoDocumentoChange()"
              >
                <ng-template let-item>
                  <div class="option-inline">
                    <i [class]="item.icon"></i>
                    <span>{{ item.label }}</span>
                  </div>
                </ng-template>
              </p-selectButton>
            </div>
          </div>

          <p-divider styleClass="section-divider" />

          <div class="cliente-section">
            <label class="section-label">
              <i class="pi pi-user"></i>
              Datos del Cliente
            </label>

            <div class="buscar-cliente-section">
              <label class="input-label">{{ tipoDocumento }}</label>

              <div class="flex gap-2 align-items-center input-buscar-row">
                <div class="input-buscar-wrapper">
                  <input
                    pInputText
                    [(ngModel)]="busquedaComprobante"
                    (input)="validarSoloNumeros($event)"
                    [placeholder]="
                      'Ingrese ' +
                      tipoDocumento +
                      ' (' +
                      (tipoDocumento === 'DNI' ? '8' : '11') +
                      ' dígitos)'
                    "
                    inputmode="numeric"
                    pattern="[0-9]*"
                    [maxlength]="tipoDocumento === 'DNI' ? 8 : 11"
                    class="w-full input-buscar-documento"
                    [disabled]="clienteEncontrado !== null"
                  />
                </div>

                <div class="boton-buscar-wrapper">
                  <p-button
                    [label]="textoBotonBuscar"
                    icon="pi pi-search"
                    severity="primary"
                    (onClick)="manejarBuscarComprobante()"
                    [disabled]="!botonBuscarHabilitado || clienteEncontrado !== null"
                    styleClass="w-full btn-buscar-cliente"
                    [pTooltip]="
                      clienteEncontrado
                        ? 'Cliente ya seleccionado'
                        : !botonBuscarHabilitado
                          ? 'Ingrese ' + (tipoDocumento === 'DNI' ? '8' : '11') + ' dígitos'
                          : 'Buscar cliente'
                    "
                    tooltipPosition="bottom"
                  />
                </div>
              </div>

              <div
                *ngIf="busquedaComprobante && !clienteEncontrado"
                class="mt-2 flex align-items-center gap-2"
              >
                <i class="pi pi-info-circle text-500"></i>
                <small class="text-600">
                  {{ busquedaComprobante.length }} / {{ tipoDocumento === 'DNI' ? '8' : '11' }}
                  dígitos
                  <span
                    *ngIf="busquedaComprobante.length < (tipoDocumento === 'DNI' ? 8 : 11)"
                    class="text-orange-500"
                  >
                    ({{ (tipoDocumento === 'DNI' ? 8 : 11) - busquedaComprobante.length }}
                    restantes)
                  </span>
                  <span
                    *ngIf="busquedaComprobante.length === (tipoDocumento === 'DNI' ? 8 : 11)"
                    class="text-green-500"
                  >
                    ✓ Completo
                  </span>
                </small>
              </div>
            </div>

            <div *ngIf="clienteEncontrado" class="cliente-encontrado-card mt-3">
              <p-card styleClass="cliente-card-success">
                <div class="cliente-content">
                  <div class="cliente-cabecera-row">
                    <div class="cliente-row">
                      <h4 class="cliente-nombre">
                        {{ getNombreCliente(clienteEncontrado) }}
                      </h4>
                      <span class="badge-verified">
                        <i class="pi pi-check-circle"></i>
                        Verificado
                      </span>
                      <p-button
                        icon="pi pi-times-circle"
                        [text]="true"
                        severity="secondary"
                        size="small"
                        (onClick)="limpiarBusqueda()"
                        pTooltip="Cambiar cliente"
                        tooltipPosition="left"
                        styleClass="btn-close-cliente"
                      />
                    </div>
                  </div>

                  <div class="cliente-row mt-3">
                    <span class="info-badge dni">
                      <i class="pi pi-id-card"></i>
                      {{ tipoDocumento }}: {{ clienteEncontrado.num_doc }}
                    </span>
                    <span class="info-badge telefono" *ngIf="clienteEncontrado.telefono">
                      <i class="pi pi-phone"></i>
                      {{ clienteEncontrado.telefono }}
                    </span>
                  </div>

                  <div class="cliente-row mt-3" *ngIf="clienteEncontrado.email">
                    <span class="info-badge email">
                      <i class="pi pi-envelope"></i>
                      {{ clienteEncontrado.email }}
                    </span>
                  </div>

                  <div class="cliente-row mt-3" *ngIf="clienteEncontrado.direccion">
                    <span class="info-badge direccion">
                      <i class="pi pi-map-marker"></i>
                      {{ clienteEncontrado.direccion }}
                    </span>
                  </div>

                  <p-divider styleClass="mt-3 mb-3" />
                  <div class="compras-registradas-box">
                    <div class="flex align-items-center gap-2">
                      <i class="pi pi-shopping-cart compras-icon"></i>
                      <span class="compras-text">
                        Compras registradas: {{ comprobantesCliente.length }}
                      </span>
                    </div>
                  </div>
                </div>
              </p-card>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="activeStep === 1" class="step-content">
        <div class="step-header">
          <i class="pi pi-file-check step-icon"></i>
          <h3>Seleccionar Comprobante</h3>
        </div>

        <div class="content-centrado">
          <div *ngIf="comprobantesCliente.length > 0" class="mt-3">
            <p class="text-600 mb-3">
              <i class="pi pi-info-circle mr-2"></i>
              Seleccione el comprobante que desea reclamar (clic nuevamente para deseleccionar):
            </p>

            <div class="grid gap-3">
              <div
                *ngFor="let comprobante of comprobantesCliente"
                class="col-12"
                (click)="seleccionarComprobanteDeCliente(comprobante)"
              >
                <div
                  class="comprobante-item-card"
                  [class.comprobante-seleccionado]="
                    comprobanteSeleccionado?.id_comprobante === comprobante.id_comprobante
                  "
                  [class.comprobante-no-seleccionado]="
                    comprobanteSeleccionado?.id_comprobante !== comprobante.id_comprobante
                  "
                >
                  <div class="comprobante-header-row">
                    <div class="flex align-items-center gap-3">
                      <span class="comprobante-numero">
                        {{ formatearComprobante(comprobante.serie, comprobante.numero) }}
                      </span>
                    </div>

                    <div class="flex align-items-center gap-2">
                      <p-tag
                        [value]="getTipoComprobanteLabel(comprobante.tipo_comprobante)"
                        [severity]="comprobante.tipo_comprobante === '01' ? 'success' : 'info'"
                      />
                      <span
                        *ngIf="
                          comprobanteSeleccionado?.id_comprobante === comprobante.id_comprobante
                        "
                        class="badge-seleccionado"
                      >
                        <i class="pi pi-check-circle"></i>
                        Seleccionado
                      </span>
                    </div>
                  </div>

                  <div class="grid">
                    <div class="col-6">
                      <span class="info-badge fecha-badge">
                        <i class="pi pi-calendar"></i>
                        {{ comprobante.fec_emision | date: 'dd/MM/yyyy' }}
                      </span>
                    </div>
                    <div class="col-6">
                      <span class="info-badge total-badge">
                        <i class="pi pi-dollar"></i>
                        Total: S/. {{ comprobante.total | number: '1.2-2' }}
                      </span>
                    </div>
                  </div>

                  <div class="mt-3">
                    <div
                      class="garantia-box"
                      [class.vigente]="validarGarantia(comprobante.fec_emision)"
                      [class.vencida]="!validarGarantia(comprobante.fec_emision)"
                    >
                      <i
                        [class]="
                          validarGarantia(comprobante.fec_emision)
                            ? 'pi pi-check-circle'
                            : 'pi pi-times-circle'
                        "
                      ></i>
                      <div class="garantia-info">
                        <strong>{{
                          validarGarantia(comprobante.fec_emision)
                            ? 'Garantía Vigente'
                            : 'Garantía Vencida'
                        }}</strong>
                        <small *ngIf="validarGarantia(comprobante.fec_emision)">
                          {{ calcularDiasRestantesComprobante(comprobante.fec_emision) }} días
                          restantes
                        </small>
                        <small *ngIf="!validarGarantia(comprobante.fec_emision)">
                          Venció hace
                          {{ Math.abs(calcularDiasRestantesComprobante(comprobante.fec_emision)) }}
                          días
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="comprobantesCliente.length === 0" class="text-center p-5">
            <i class="pi pi-inbox text-6xl text-400 mb-3"></i>
            <p class="text-600 text-lg">No hay comprobantes disponibles para este cliente</p>
          </div>
        </div>
      </div>

      <div *ngIf="activeStep === 2" class="step-content">
        <div class="step-header">
          <i class="pi pi-box step-icon"></i>
          <h3>Seleccionar Producto</h3>
        </div>

        <div class="productos-list">
          <div
            *ngFor="let producto of comprobanteSeleccionado?.productosSeleccionados"
            class="producto-card"
            [class.selected]="productoSeleccionado?.id_producto === producto.id_producto"
            (click)="seleccionarProducto(producto)"
          >
            <div class="producto-header">
              <span class="producto-codigo">{{ producto.id_producto }}</span>
              <i
                *ngIf="productoSeleccionado?.id_producto === producto.id_producto"
                class="pi pi-check-circle check-icon"
              ></i>
            </div>

            <h4 class="producto-nombre">{{ producto.descripcion }}</h4>

            <div class="producto-footer">
              <span class="cantidad">Cant: {{ producto.cantidad }}</span>
              <span class="precio">S/. {{ getPrecioProducto(producto) | number: '1.2-2' }}</span>
            </div>
          </div>
        </div>

        <div *ngIf="productoSeleccionado && productoSeleccionado.cantidad > 1" class="mt-4">
          <p-card styleClass="unidad-selector-card">
            <div class="unidad-selector-content">
              <div class="flex align-items-center gap-2 mb-4">
                <i class="pi pi-info-circle unidad-info-icon"></i>
                <span class="font-semibold unidad-info-text">
                  Este producto tiene {{ productoSeleccionado.cantidad }} unidades. ¿Cuántas tienen
                  el problema?
                </span>
              </div>

              <div class="flex align-items-center gap-4 mb-4">
                <label class="input-label mb-0">Unidades con defecto:</label>
                <p-inputNumber
                  [(ngModel)]="unidadesAfectadas"
                  [min]="1"
                  [max]="productoSeleccionado.cantidad"
                  [showButtons]="true"
                  buttonLayout="horizontal"
                  inputId="horizontal"
                  spinnerMode="horizontal"
                  decrementButtonClass="p-button-secondary"
                  incrementButtonClass="p-button-secondary"
                  incrementButtonIcon="pi pi-plus"
                  decrementButtonIcon="pi pi-minus"
                  styleClass="unidad-input"
                >
                </p-inputNumber>
                <span class="text-500">de {{ productoSeleccionado.cantidad }}</span>
              </div>

              <div class="mt-3">
                <label class="input-label">Identificación adicional (opcional):</label>
                <textarea
                  pTextarea
                  [(ngModel)]="identificacionUnidad"
                  placeholder="Ej: 'La segunda unidad que recibí', 'El de número de serie XYZ123', etc."
                  rows="2"
                  class="w-full"
                ></textarea>
                <small class="text-500 mt-2 block">
                  Ayuda a identificar cuál(es) de las {{ productoSeleccionado.cantidad }} unidades
                  tiene(n) el problema
                </small>
              </div>
            </div>
          </p-card>
        </div>
      </div>

      <div *ngIf="activeStep === 3" class="step-content">
        <div class="step-header">
          <i class="pi pi-file-edit step-icon"></i>
          <h3>Datos del Reclamo</h3>
        </div>

        <div class="content-centrado">
          <div class="form-field mb-4">
            <label class="input-label">Motivo del Reclamo *</label>
            <p-select
              [(ngModel)]="motivoSeleccionado"
              [options]="motivosOptions"
              placeholder="Seleccione un motivo"
              styleClass="w-full"
            />
          </div>

          <div class="form-field">
            <label class="input-label">Descripción del Problema *</label>
            <textarea
              pTextarea
              [(ngModel)]="descripcionProblema"
              placeholder="Describa detalladamente el problema (mínimo 20 caracteres)"
              rows="6"
              class="w-full"
            ></textarea>
            <small class="text-500 mt-1 block">
              {{ descripcionProblema.length || 0 }} / 20 caracteres mínimos
            </small>
          </div>
        </div>
      </div>

      <div *ngIf="activeStep === 4" class="step-content">
        <div *ngIf="!reclamoGenerado">
          <div class="step-header">
            <i class="pi pi-check-circle step-icon"></i>
            <h3>Confirmar Reclamo</h3>
          </div>

          <div class="content-centrado">
            <p-card styleClass="resumen-reclamo">
              <h4 class="resumen-titulo mb-4">
                <i class="pi pi-file-check"></i>
                Resumen del Reclamo
              </h4>

              <div class="resumen-grid">
                <div class="resumen-item">
                  <span class="label">
                    <i class="pi pi-user"></i>
                    Cliente:
                  </span>
                  <strong>{{ comprobanteSeleccionado?.cliente_nombre }}</strong>
                </div>

                <div class="resumen-item">
                  <span class="label">
                    <i class="pi pi-file"></i>
                    Comprobante:
                  </span>
                  <strong>
                    {{
                      formatearComprobante(
                        comprobanteSeleccionado!.serie,
                        comprobanteSeleccionado!.numero
                      )
                    }}
                  </strong>
                </div>

                <div class="resumen-item">
                  <span class="label">
                    <i class="pi pi-box"></i>
                    Producto:
                  </span>
                  <strong>{{ productoSeleccionado?.descripcion }}</strong>
                </div>

                <div class="resumen-item">
                  <span class="label">
                    <i class="pi pi-exclamation-triangle"></i>
                    Motivo:
                  </span>
                  <p-tag [value]="motivoSeleccionado" severity="warn" />
                </div>

                <div class="resumen-item full-width">
                  <span class="label">
                    <i class="pi pi-comment"></i>
                    Descripción:
                  </span>
                  <p class="descripcion-texto">{{ descripcionProblema }}</p>
                </div>
              </div>

              <div class="mt-4">
                <p-button
                  label="Registrar Reclamo"
                  icon="pi pi-check"
                  [loading]="guardando"
                  (onClick)="guardarReclamo()"
                  styleClass="w-full btn-generar-venta"
                />
              </div>
            </p-card>
          </div>
        </div>

        <div *ngIf="reclamoGenerado" class="venta-exitosa">
          <div class="success-animation">
            <i class="pi pi-check-circle"></i>
          </div>
          <h2 class="mb-6">¡Reclamo Registrado Exitosamente!</h2>

          <div class="comprobante-wrapper">
            <p-card styleClass="comprobante-info-card">
              <div class="comprobante-header">
                <div class="comprobante-numero">
                  <span class="numero-label">RECLAMO N°:</span>
                  <h3 class="numero-valor">{{ reclamoGenerado.id_reclamo }}</h3>
                </div>
                <p-tag value="PENDIENTE" severity="warn" />
              </div>

              <p-divider styleClass="comprobante-divider" />

              <div class="info-grid">
                <div class="info-item">
                  <span class="label">
                    <i class="pi pi-user"></i>
                    Cliente:
                  </span>
                  <strong>{{ reclamoGenerado.cliente_nombre }}</strong>
                </div>
                <div class="info-item">
                  <span class="label">
                    <i class="pi pi-box"></i>
                    Producto:
                  </span>
                  <strong>{{ reclamoGenerado.descripcion_producto }}</strong>
                </div>
                <div class="info-item">
                  <span class="label">
                    <i class="pi pi-calendar"></i>
                    Fecha de Registro:
                  </span>
                  <strong>{{ reclamoGenerado.fecha_registro | date: 'dd/MM/yyyy HH:mm' }}</strong>
                </div>
                <div class="info-item">
                  <span class="label">
                    <i class="pi pi-exclamation-triangle"></i>
                    Motivo:
                  </span>
                  <strong>{{ reclamoGenerado.motivo }}</strong>
                </div>
              </div>
            </p-card>
          </div>

          <div class="action-buttons-final mt-4">
            <p-button
              label="Ver Detalle"
              icon="pi pi-eye"
              (onClick)="verDetalle()"
              styleClass="w-full btn-accion-final"
            />
            <p-button
              label="Nuevo Reclamo"
              icon="pi pi-plus"
              severity="success"
              (onClick)="nuevoReclamo()"
              styleClass="w-full btn-accion-final"
            />
            <p-button
              label="Ver Listado"
              icon="pi pi-list"
              [outlined]="true"
              (onClick)="cancelar()"
              styleClass="w-full btn-accion-final"
            />
          </div>
        </div>
      </div>
    </div>

    <p-divider styleClass="wizard-divider" />

    <div *ngIf="activeStep < 4 || !reclamoGenerado" class="step-actions">
      <p-button
        *ngIf="activeStep > 0"
        label="Anterior"
        icon="pi pi-arrow-left"
        [outlined]="true"
        severity="secondary"
        (onClick)="prevStep()"
      />
      <span *ngIf="activeStep === 0"></span>

      <p-button
        *ngIf="activeStep < 4"
        label="Siguiente"
        icon="pi pi-arrow-right"
        iconPos="right"
        (onClick)="nextStep()"
      />
    </div>
  </p-card>
</div>

<p-toast />
