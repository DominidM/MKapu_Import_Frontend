<div class="p-2">
  <p-card class="ventas-header-card mb-4 ventas-header-bordered">
    <div class="flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="flex align-items-center gap-3">
        <span class="ventas-title-icon">
          <i [class]="iconoCabecera"></i>
        </span>
        <div>
          <p class="ventas-kicker mb-0">{{ tituloKicker }}</p>
          <h2 class="ventas-title mb-0">{{ subtituloKicker }}</h2>
        </div>
      </div>
      <div class="flex gap-2">
        <p-button
          label="Ver Listado"
          icon="pi pi-list"
          [outlined]="true"
          severity="secondary"
          styleClass="ventas-pill"
          (onClick)="verListado()"
          pTooltip="Ver historial de ventas"
          tooltipPosition="bottom"
        />
        <p-button
          label="Nueva Venta"
          icon="pi pi-refresh"
          styleClass="ventas-pill"
          (onClick)="nuevaVenta()"
          pTooltip="Reiniciar formulario"
          tooltipPosition="bottom"
          [disabled]="!comprobanteGenerado()"
        />
      </div>
    </div>
  </p-card>
</div>

<div class="p-2">
  <p-card class="wizard-card">
    <div class="wizard-steps">
      <div
        *ngFor="let step of steps; let i = index"
        class="wizard-step"
        [class.active]="activeStep() === i"
        [class.completed]="activeStep() > i"
      >
        <div class="step-number">
          <i *ngIf="activeStep() > i" class="pi pi-check"></i>
          <span *ngIf="activeStep() <= i">{{ i + 1 }}</span>
        </div>
        <div class="step-title">{{ step }}</div>
      </div>
    </div>

    <p-divider styleClass="wizard-divider" />

    <div class="wizard-content">
      <!-- PASO 1: Comprobante y Cliente -->
      <div *ngIf="activeStep() === 0" class="step-content">
        <div class="step-header">
          <i class="pi pi-file-edit step-icon"></i>
          <h3>Datos del Comprobante y Cliente</h3>
        </div>

        <div class="content-centrado">
          <div class="comprobante-section">
            <label class="section-label">
              <i class="pi pi-file-edit"></i>
              Tipo de Comprobante
            </label>
            <div class="flex justify-content-center">
              <p-selectButton
                [ngModel]="tipoComprobante()"
                (ngModelChange)="onTipoComprobanteChange($event)"
                [options]="tipoComprobanteOptions"
                optionLabel="label"
                optionValue="value"
                styleClass="select-comprobante-inline"
              >
                <ng-template let-item>
                  <div class="option-inline">
                    <i [class]="item.icon"></i>
                    <span>{{ item.label }}</span>
                  </div>
                </ng-template>
              </p-selectButton>
            </div>
          </div>

          <p-divider styleClass="section-divider" />

          <div class="cliente-section">
            <label class="section-label">
              <i class="pi pi-users"></i>
              Datos del Cliente
            </label>

            <div class="buscar-cliente-section">
              <label class="input-label">{{ tipoComprobante() === 2 ? 'DNI' : 'RUC' }}</label>

              <div class="flex gap-2 align-items-center">
                <div style="flex: 1; min-width: 0">
                  <input
                    pInputText
                    [ngModel]="clienteAutoComplete()"
                    (ngModelChange)="clienteAutoComplete.set($event)"
                    class="w-full autocomplete-clientes"
                    [placeholder]="
                      tipoComprobante() === 2
                        ? 'Ingrese DNI (8 dígitos)'
                        : 'Ingrese RUC (11 dígitos)'
                    "
                    [maxlength]="tipoComprobante() === 2 ? 8 : 11"
                    inputmode="numeric"
                    pattern="[0-9]*"
                    (input)="validarSoloNumeros($event); onInputCambioDocumento()"
                    (keyup.enter)="manejarAccionCliente()"
                    [disabled]="loading()"
                  />
                </div>

                <div style="flex: 0 0 200px">
                  <p-button
                    [label]="textoBotonCliente()"
                    [icon]="iconoBotonCliente()"
                    severity="primary"
                    (onClick)="manejarAccionCliente()"
                    [disabled]="
                      !botonClienteHabilitado() || clienteEncontrado() !== null || loading()
                    "
                    [loading]="loading()"
                    styleClass="w-full btn-buscar-cliente"
                    [pTooltip]="
                      clienteEncontrado()
                        ? 'Cliente ya seleccionado'
                        : !botonClienteHabilitado()
                          ? 'Complete ' + (tipoComprobante() === 2 ? '8' : '11') + ' dígitos'
                          : ''
                    "
                    tooltipPosition="bottom"
                  />
                </div>
              </div>

              <div
                *ngIf="clienteAutoComplete() && !clienteEncontrado() && !loading()"
                class="mt-2 flex align-items-center gap-2"
              >
                <i class="pi pi-info-circle text-500"></i>
                <small class="text-600">
                  {{ clienteAutoComplete().length || 0 }} /
                  {{ tipoComprobante() === 2 ? '8' : '11' }} dígitos
                  <span
                    *ngIf="(clienteAutoComplete().length || 0) < (tipoComprobante() === 2 ? 8 : 11)"
                    class="text-orange-500"
                  >
                    ({{ (tipoComprobante() === 2 ? 8 : 11) - (clienteAutoComplete().length || 0) }}
                    restantes)
                  </span>
                  <span
                    *ngIf="
                      (clienteAutoComplete().length || 0) === (tipoComprobante() === 2 ? 8 : 11)
                    "
                    class="text-green-500"
                  >
                    ✓ Completo
                  </span>
                </small>
              </div>
            </div>

            <div *ngIf="clienteEncontrado()" class="cliente-encontrado-card mt-3">
              <p-card styleClass="cliente-card-success">
                <div class="cliente-content">
                  <div class="cliente-cabecera-row">
                    <div class="cliente-row">
                      <h4 class="cliente-nombre">
                        {{ clienteEncontrado()!.name }}
                      </h4>
                      <span class="badge-verified">
                        <i class="pi pi-check-circle"></i>
                        {{ clienteEncontrado()!.status ? 'Activo' : 'Inactivo' }}
                      </span>
                      <p-button
                        icon="pi pi-times-circle"
                        [text]="true"
                        severity="secondary"
                        size="small"
                        (onClick)="limpiarCliente()"
                        pTooltip="Cambiar cliente"
                        tooltipPosition="left"
                        styleClass="btn-close-cliente"
                      />
                    </div>
                  </div>

                  <div class="cliente-row mt-3">
                    <span class="info-badge dni">
                      <i class="pi pi-id-card"></i>
                      {{ formatearDocumentoCompleto() }}
                    </span>
                    <span class="info-badge telefono" *ngIf="clienteEncontrado()!.phone">
                      <i class="pi pi-phone"></i>
                      {{ clienteEncontrado()!.phone }}
                    </span>
                  </div>

                  <div class="cliente-row mt-3" *ngIf="clienteEncontrado()!.email">
                    <span class="info-badge email">
                      <i class="pi pi-envelope"></i>
                      {{ clienteEncontrado()!.email }}
                    </span>
                  </div>

                  <div class="cliente-row mt-3" *ngIf="clienteEncontrado()!.address">
                    <span class="info-badge direccion">
                      <i class="pi pi-map-marker"></i>
                      {{ clienteEncontrado()!.address }}
                    </span>
                  </div>
                </div>
              </p-card>
            </div>

            <div
              *ngIf="busquedaRealizada() && !clienteEncontrado() && !loading()"
              class="cliente-no-encontrado mt-3"
            >
              <p-card styleClass="cliente-card-success">
                <div class="text-center">
                  <i class="pi pi-exclamation-triangle text-orange-500" style="font-size: 2rem"></i>
                  <h4 class="mt-3 mb-2">Cliente no encontrado</h4>
                  <p class="text-600">El documento ingresado no está registrado en el sistema.</p>
                  <small class="text-500"
                    >Contacte al administrador para registrar nuevos clientes.</small
                  >
                </div>
              </p-card>
            </div>
          </div>
        </div>
      </div>

      <!-- PASO 2: Productos -->
      <div *ngIf="activeStep() === 1" class="step-content">
        <div class="step-header">
          <i class="pi pi-box step-icon"></i>
          <h3>Seleccionar Productos</h3>
        </div>

        <div class="productos-container">
          <div class="seccion-busquedas">
            <div class="filtros-productos">
              <div class="buscar-producto-auto">
                <label class="font-semibold mb-2 block">Buscar producto</label>
                <p-autocomplete
                  [ngModel]="productoSeleccionadoBusqueda()"
                  (ngModelChange)="productoSeleccionadoBusqueda.set($event)"
                  [suggestions]="productosSugeridos()"
                  (completeMethod)="buscarProductos($event)"
                  (onSelect)="onProductoSeleccionado($event)"
                  (onClear)="onLimpiarBusqueda()"
                  [dropdown]="true"
                  placeholder="Buscar por nombre o código"
                  [forceSelection]="false"
                  [showEmptyMessage]="true"
                  emptyMessage="No se encontraron productos"
                  styleClass="w-full autocomplete-productos-search"
                  [minLength]="2"
                >
                  <ng-template let-producto pTemplate="item">
                    <div class="producto-suggestion-mejorado">
                      <div class="suggestion-row-1">
                        <span class="suggestion-codigo-nuevo">{{ producto.codigo }}</span>
                        <p-tag
                          [value]="producto.familia"
                          severity="info"
                          styleClass="suggestion-tag-nuevo"
                        />
                      </div>

                      <div class="suggestion-row-2">
                        <span class="suggestion-nombre-nuevo">{{ producto.nombre }}</span>
                        <div class="flex align-items-center gap-2">
                          <span class="suggestion-precio-nuevo">
                            S/. {{ producto.precioUnidad | number: '1.2-2' }}
                          </span>
                          <p-tag
                            [value]="'Stock: ' + producto.stock"
                            [severity]="obtenerSeveridadStock(producto.stock)"
                            styleClass="suggestion-stock-tag"
                          />
                        </div>
                      </div>
                    </div>
                  </ng-template>
                </p-autocomplete>
              </div>

              <div class="familia-selector">
                <label class="font-semibold mb-2 block">Familia</label>
                <p-select
                  [ngModel]="familiaSeleccionada()"
                  (ngModelChange)="onFamiliaChange($event)"
                  [options]="familiasDisponibles()"
                  placeholder="Todas las familias"
                  [showClear]="true"
                  styleClass="w-full"
                  optionLabel="label"
                  optionValue="value"
                >
                  <ng-template pTemplate="selectedItem" let-option>
                    <div class="familia-option" *ngIf="option">
                      <i class="pi pi-tag"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                  <ng-template let-option pTemplate="item">
                    <div class="familia-option">
                      <i class="pi pi-tag"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                </p-select>
              </div>
            </div>
          </div>

          <div class="seccion-productos-agregar">
            <div class="columna-productos-disponibles">
              <div class="columna-header">
                <h4>
                  <i class="pi pi-box"></i>
                  Productos Disponibles ({{ productosFiltrados().length }})
                </h4>
              </div>
              <div class="columna-scroll">
                <div
                  *ngFor="let producto of productosFiltrados()"
                  class="producto-item"
                  [class.selected]="productoTemp()?.id === producto.id"
                  (click)="seleccionarProducto(producto)"
                >
                  <div class="flex justify-content-between align-items-center mb-2">
                    <span class="codigo">{{ producto.codigo }}</span>
                    <p-tag [value]="producto.familia" severity="info" />
                  </div>
                  <div class="producto-nombre mb-2">{{ producto.nombre }}</div>

                  <div class="producto-stock mb-2">
                    <p-tag
                      [value]="'Stock: ' + producto.stock"
                      [severity]="obtenerSeveridadStock(producto.stock)"
                      icon="pi pi-box"
                    />
                  </div>

                  <div class="producto-precios">
                    <small>
                      <strong>Unidad:</strong> S/. {{ producto.precioUnidad | number: '1.2-2' }}
                    </small>
                    <small>
                      <strong>Caja:</strong> S/. {{ producto.precioCaja | number: '1.2-2' }}
                    </small>
                    <small>
                      <strong>Mayorista:</strong> S/.
                      {{ producto.precioMayorista | number: '1.2-2' }}
                    </small>
                  </div>
                </div>

                <div *ngIf="productosFiltrados().length === 0" class="no-productos">
                  <i class="pi pi-inbox"></i>
                  <p>No se encontraron productos</p>
                </div>
              </div>
            </div>

            <div class="columna-agregar-carrito">
              <div class="columna-header">
                <h4>
                  <i class="pi pi-plus-circle"></i>
                  Agregar al Carrito
                </h4>
              </div>
              <div class="columna-scroll">
                <div *ngIf="productoTemp()" class="form-agregar">
                  <div class="producto-seleccionado mb-3">
                    <strong class="block mb-1">{{ productoTemp()!.nombre }}</strong>
                    <small class="text-600">{{ productoTemp()!.codigo }}</small>

                    <div class="mt-2">
                      <p-tag
                        [value]="'Stock disponible: ' + productoTemp()!.stock"
                        [severity]="obtenerSeveridadStock(productoTemp()!.stock)"
                        icon="pi pi-box"
                      />
                    </div>
                  </div>

                  <div class="form-field mb-3">
                    <label class="block mb-2 font-semibold">Tipo de Precio</label>
                    <p-selectButton
                      [ngModel]="tipoPrecioTemp()"
                      (ngModelChange)="tipoPrecioTemp.set($event)"
                      [options]="opcionesTipoPrecio"
                      optionLabel="label"
                      optionValue="value"
                      styleClass="w-full"
                    />
                  </div>

                  <div class="form-field mb-3">
                    <label class="block mb-2 font-semibold">Cantidad</label>
                    <p-inputNumber
                      [ngModel]="cantidadTemp()"
                      (ngModelChange)="cantidadTemp.set($event)"
                      [min]="1"
                      [max]="productoTemp()!.stock"
                      [showButtons]="true"
                      styleClass="w-full"
                    />
                    <small class="text-600 mt-1 block"
                      >Máximo: {{ productoTemp()!.stock }} unidades</small
                    >
                  </div>

                  <div class="precio-display mb-3">
                    <span>Precio Unitario</span>
                    <span class="precio-valor">
                      S/. {{ precioSegunTipo() | number: '1.2-2' }}
                    </span>
                  </div>

                  <div class="total-display mb-3">
                    <span>Total</span>
                    <span class="total-valor">
                      S/. {{ precioSegunTipo() * cantidadTemp() | number: '1.2-2' }}
                    </span>
                  </div>

                  <p-button
                    label="Agregar al Carrito"
                    icon="pi pi-plus"
                    (onClick)="agregarProducto()"
                    [disabled]="cantidadTemp() <= 0 || cantidadTemp() > productoTemp()!.stock"
                    styleClass="w-full btn-agregar-producto"
                  />

                  <small
                    *ngIf="cantidadTemp() > productoTemp()!.stock"
                    class="text-red-500 mt-2 block text-center"
                  >
                    <i class="pi pi-exclamation-triangle"></i>
                    Stock insuficiente. Disponible: {{ productoTemp()!.stock }} unidades
                  </small>

                  <small
                    *ngIf="cantidadTemp() > 0 && cantidadTemp() <= productoTemp()!.stock"
                    class="text-green-500 mt-2 block text-center"
                  >
                    <i class="pi pi-check-circle"></i>
                    Stock disponible
                  </small>
                </div>

                <div *ngIf="!productoTemp()" class="no-seleccion">
                  <i class="pi pi-hand-pointer"></i>
                  <p>Seleccione un producto de la lista</p>
                </div>
              </div>
            </div>
          </div>

          <div class="seccion-carrito-completo">
            <div class="carrito-header">
              <h4>
                <i class="pi pi-shopping-cart"></i>
                Carrito de Compras ({{ productosSeleccionados().length }} items)
              </h4>
            </div>

            <div class="carrito-contenido">
              <div *ngIf="productosSeleccionados().length > 0" class="carrito-tabla">
                <p-table
                  [value]="productosSeleccionados()"
                  styleClass="p-datatable-sm tabla-carrito-productos"
                  [tableStyle]="{ 'min-width': '100%' }"
                >
                  <ng-template pTemplate="header">
                    <tr>
                      <th style="width: 120px">Código</th>
                      <th>Producto</th>
                      <th class="text-right" style="width: 100px">Cantidad</th>
                      <th class="text-right" style="width: 120px">Precio Unit.</th>
                      <th class="text-right" style="width: 130px">Subtotal</th>
                      <th class="text-center" style="width: 80px">Acción</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
                    <tr>
                      <td>
                        <span class="codigo-tabla">{{ item.productId }}</span>
                      </td>
                      <td>
                        <span class="producto-nombre-tabla">{{ item.description }}</span>
                      </td>
                      <td class="text-right">
                        <span class="cantidad-badge">{{ item.quantity }}</span>
                      </td>
                      <td class="text-right">
                        <strong>S/. {{ item.unitPrice | number: '1.2-2' }}</strong>
                      </td>
                      <td class="text-right">
                        <strong class="subtotal-item">
                          S/. {{ item.total | number: '1.2-2' }}
                        </strong>
                      </td>
                      <td class="text-center">
                        <p-button
                          icon="pi pi-trash"
                          severity="danger"
                          [text]="true"
                          [rounded]="true"
                          size="small"
                          (onClick)="eliminarProducto(rowIndex)"
                          pTooltip="Eliminar producto"
                          tooltipPosition="left"
                        />
                      </td>
                    </tr>
                  </ng-template>
                </p-table>

                <div class="carrito-totales-box">
                  <div class="totales-contenido">
                    <div class="total-line">
                      <span class="label">Subtotal (Base imponible):</span>
                      <span class="total-valor">S/. {{ subtotal() | number: '1.2-2' }}</span>
                    </div>

                    <div class="total-line">
                      <span class="label">IGV (18%):</span>
                      <span class="total-valor">S/. {{ igv() | number: '1.2-2' }}</span>
                    </div>

                    <div class="total-line total-final">
                      <span class="label">TOTAL A PAGAR:</span>
                      <span class="total-valor">S/. {{ total() | number: '1.2-2' }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <div *ngIf="productosSeleccionados().length === 0" class="carrito-vacio">
                <i class="pi pi-shopping-cart"></i>
                <p>El carrito está vacío</p>
                <small>Agregue productos para continuar con la venta</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PASO 3: Forma de Pago -->
      <div *ngIf="activeStep() === 2" class="step-content">
        <div class="step-header">
          <i class="pi pi-credit-card step-icon"></i>
          <h3>Forma de Pago</h3>
        </div>

        <div class="content-centrado">
          <div class="tipo-pago-section">
            <label class="section-label">
              <i class="pi pi-wallet"></i>
              Método de Pago
            </label>
            <div class="metodos-pago-grid">
              <div
                *ngFor="let metodo of metodoPagoOptions"
                class="metodo-pago-card"
                [class.selected]="metodoPagoSeleccionado() === metodo.value"
                (click)="metodoPagoSeleccionado.set(metodo.value)"
              >
                <div class="metodo-icon">
                  <i [class]="metodo.icon"></i>
                </div>
                <span class="metodo-label">{{ metodo.label }}</span>
                <div class="check-indicator" *ngIf="metodoPagoSeleccionado() === metodo.value">
                  <i class="pi pi-check"></i>
                </div>
              </div>
            </div>

            <div class="promociones-section mt-4">
              <div class="promociones-header">
                <div class="flex align-items-center gap-2">
                  <i class="pi pi-percentage"></i>
                  <span>Aplicar Promoción</span>
                </div>
                <p-tag value="Próximamente" severity="warn" styleClass="tag-proximamente" />
              </div>

              <div class="buscar-promocion-wrapper">
                <label class="input-label mb-2">Código de Promoción</label>
                <div class="flex gap-2 align-items-center">
                  <div style="flex: 1; min-width: 0">
                    <input
                      pInputText
                      class="w-full input-promocion"
                      placeholder="Ingrese código promocional (ej: VERANO2026)"
                      disabled
                    />
                  </div>
                  <div style="flex: 0 0 160px">
                    <p-button
                      label="Aplicar"
                      icon="pi pi-check"
                      severity="success"
                      styleClass="w-full btn-aplicar-promo"
                      disabled
                      pTooltip="Función disponible próximamente"
                      tooltipPosition="bottom"
                    />
                  </div>
                </div>
              </div>

              <div class="promociones-footer">
                <i class="pi pi-info-circle"></i>
                <small
                  >Las promociones estarán disponibles próximamente. Podrás aplicar descuentos
                  especiales usando códigos promocionales.</small
                >
              </div>
            </div>

            <p-divider styleClass="section-divider" />

            <div class="pago-detalles-wrapper mt-4">
              <div *ngIf="metodoPagoSeleccionado() === 1" class="pago-detalles-animated">
                <div class="monto-destacado-box">
                  <i class="pi pi-tag"></i>
                  <span>Total a Pagar:</span>
                  <strong class="monto-destacado">S/. {{ total() | number: '1.2-2' }}</strong>
                </div>

                <div class="form-field">
                  <label class="input-label">Monto Recibido *</label>
                  <p-inputNumber
                    [ngModel]="montoRecibido()"
                    (ngModelChange)="montoRecibido.set($event)"
                    mode="currency"
                    currency="PEN"
                    locale="es-PE"
                    [min]="0"
                    styleClass="w-full"
                  />
                </div>

                <div *ngIf="montoRecibido() >= total()" class="vuelto-display mt-3">
                  <span>Vuelto:</span>
                  <span class="vuelto-valor">S/. {{ vuelto() | number: '1.2-2' }}</span>
                </div>
              </div>

              <div *ngIf="metodoPagoSeleccionado() !== 1" class="pago-detalles-animated">
                <div class="monto-destacado-box">
                  <i class="pi pi-tag"></i>
                  <span>Total a Pagar:</span>
                  <strong class="monto-destacado">S/. {{ total() | number: '1.2-2' }}</strong>
                </div>

                <div class="pago-header-inline mt-3">
                  <i class="pi pi-mobile"></i>
                  <span>Detalles del Pago</span>
                </div>

                <div class="campo-pago-item mt-3">
                  <div class="campo-pago-header">
                    <i class="pi pi-hashtag"></i>
                    <span>N° de Operación *</span>
                  </div>
                  <input
                    pInputText
                    [ngModel]="numeroOperacion()"
                    (ngModelChange)="numeroOperacion.set($event)"
                    placeholder="Ingrese número de operación"
                    class="w-full input-operacion"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PASO 4: Confirmar Venta -->
      <div *ngIf="activeStep() === 3" class="step-content">
        <div *ngIf="!comprobanteGenerado()">
          <div class="step-header">
            <i class="pi pi-check-circle step-icon"></i>
            <h3>Confirmar Venta</h3>
          </div>

          <div class="content-centrado">
            <p-card class="resumen-venta">
              <h4 class="resumen-titulo mb-4">
                <i class="pi pi-file-check"></i>
                Resumen de la Venta
              </h4>

              <div class="resumen-grid mb-4">
                <div class="resumen-item">
                  <span class="label">
                    <i class="pi pi-user"></i>
                    Cliente:
                  </span>
                  <strong class="resumen-value">
                    {{ clienteEncontrado()?.name }}
                  </strong>
                </div>

                <div class="resumen-item">
                  <span class="label">
                    <i class="pi pi-file-edit"></i>
                    Tipo de Comprobante:
                  </span>
                  <p-tag
                    [value]="clienteEncontrado()?.invoiceType || 'N/A'"
                    [severity]="clienteEncontrado()?.invoiceType === 'BOLETA' ? 'info' : 'success'"
                    styleClass="resumen-tag"
                  />
                </div>

                <div class="resumen-item">
                  <span class="label">
                    <i class="pi pi-id-card"></i>
                    {{
                      obtenerSiglasDocumento(clienteEncontrado()?.documentTypeDescription || '')
                    }}:
                  </span>
                  <strong class="resumen-value">{{ clienteEncontrado()?.documentValue }}</strong>
                </div>

                <div class="resumen-item">
                  <span class="label">
                    <i class="pi pi-phone"></i>
                    Teléfono:
                  </span>
                  <strong class="resumen-value">{{
                    clienteEncontrado()?.phone || 'No registrado'
                  }}</strong>
                </div>

                <div class="resumen-item">
                  <span class="label">
                    <i class="pi pi-envelope"></i>
                    Email:
                  </span>
                  <strong class="resumen-value">{{
                    clienteEncontrado()?.email || 'No registrado'
                  }}</strong>
                </div>

                <div class="resumen-item">
                  <span class="label">
                    <i class="pi pi-map-marker"></i>
                    Dirección:
                  </span>
                  <strong class="resumen-value">{{
                    clienteEncontrado()?.address || 'No registrada'
                  }}</strong>
                </div>

                <div class="resumen-item">
                  <span class="label">
                    <i class="pi pi-shopping-cart"></i>
                    Productos:
                  </span>
                  <strong class="resumen-value">
                    {{ productosSeleccionados().length }}
                    {{ productosSeleccionados().length === 1 ? 'item' : 'items' }}
                  </strong>
                </div>

                <div class="resumen-item">
                  <span class="label">
                    <i class="pi pi-wallet"></i>
                    Método de Pago:
                  </span>
                  <p-tag
                    [value]="getLabelMetodoPago(metodoPagoSeleccionado())"
                    severity="info"
                    styleClass="resumen-tag"
                  />
                </div>
              </div>

              <p-divider styleClass="resumen-divider" />

              <div class="resumen-totales">
                <div class="total-line">
                  <span>Subtotal:</span>
                  <span>S/. {{ subtotal() | number: '1.2-2' }}</span>
                </div>
                <div class="total-line">
                  <span>IGV (18%):</span>
                  <span>S/. {{ igv() | number: '1.2-2' }}</span>
                </div>
                <div class="total-line total-final">
                  <span>TOTAL:</span>
                  <span class="total-valor">S/. {{ total() | number: '1.2-2' }}</span>
                </div>
              </div>
            </p-card>

            <div class="mt-4">
              <p-button
                label="Generar Venta"
                icon="pi pi-check"
                [loading]="loading()"
                (onClick)="generarVenta()"
                styleClass="w-full btn-generar-venta"
              />
            </div>
          </div>
        </div>

        <div *ngIf="comprobanteGenerado()" class="venta-exitosa">
          <div class="success-animation">
            <i class="pi pi-check-circle"></i>
          </div>
          <h2 class="mb-6">¡Venta Generada Exitosamente!</h2>

          <div class="comprobante-wrapper">
            <p-card class="comprobante-info-card">
              <div class="comprobante-header">
                <div class="comprobante-numero">
                  <span class="numero-label">COMPROBANTE N°:</span>
                  <h3 class="numero-valor">
                    {{ comprobanteGenerado()!.serie }}-{{ comprobanteGenerado()!.receiptNumber }}
                  </h3>
                </div>
                <p-tag
                  [value]="clienteEncontrado()?.invoiceType || 'COMPROBANTE'"
                  severity="success"
                  styleClass="comprobante-tipo-tag"
                />
              </div>

              <p-divider styleClass="comprobante-divider" />

              <div class="info-grid">
                <div class="info-item">
                  <span class="label">
                    <i class="pi pi-user"></i>
                    Cliente:
                  </span>
                  <strong>{{ clienteEncontrado()?.name }}</strong>
                </div>
                <div class="info-item">
                  <span class="label">
                    <i class="pi pi-id-card"></i>
                    Documento:
                  </span>
                  <strong>{{ clienteEncontrado()?.documentValue }}</strong>
                </div>
                <div class="info-item">
                  <span class="label">
                    <i class="pi pi-calendar"></i>
                    Fecha:
                  </span>
                  <strong>{{ comprobanteGenerado()!.createdAt | date: 'dd/MM/yyyy HH:mm' }}</strong>
                </div>
                <div class="info-item">
                  <span class="label">
                    <i class="pi pi-dollar"></i>
                    Monto Total:
                  </span>
                  <strong class="monto-total">
                    S/. {{ comprobanteGenerado()!.total | number: '1.2-2' }}
                  </strong>
                </div>
              </div>
            </p-card>
          </div>

          <div class="action-buttons-final mt-4">
            <p-button
              label="Nueva Venta"
              icon="pi pi-plus"
              severity="success"
              (onClick)="nuevaVenta()"
              styleClass="w-full btn-accion-final"
            />
            <p-button
              label="Ver Listado"
              icon="pi pi-list"
              [outlined]="true"
              (onClick)="verListado()"
              styleClass="w-full btn-accion-final"
            />
          </div>
        </div>
      </div>
    </div>

    <p-divider styleClass="wizard-divider" />

    <div *ngIf="activeStep() < 3 || !comprobanteGenerado()" class="step-actions">
      <p-button
        *ngIf="activeStep() > 0"
        label="Anterior"
        icon="pi pi-arrow-left"
        [outlined]="true"
        severity="secondary"
        (onClick)="prevStep()"
      />
      <span *ngIf="activeStep() === 0"></span>
      <p-button
        *ngIf="activeStep() < 3"
        label="Siguiente"
        icon="pi pi-arrow-right"
        iconPos="right"
        (onClick)="nextStep()"
      />
    </div>
  </p-card>
</div>

<p-toast />
<p-confirmDialog />
