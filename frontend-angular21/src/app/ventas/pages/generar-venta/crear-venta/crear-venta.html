<!-- ========================================= -->
<!-- CABECERA (NO TOCAR - CONGELADA) -->
<!-- ========================================= -->
<div class="p-2">
  <p-card styleClass="ventas-header-card mb-4 ventas-header-bordered">
    <div class="flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="flex align-items-center gap-3">
        <span class="ventas-title-icon">
          <i [class]="iconoCabecera"></i>
        </span>
        <div>
          <p class="ventas-kicker mb-0">{{ tituloKicker }}</p>
          <h2 class="ventas-title mb-0">{{ subtituloKicker }}</h2>
        </div>
      </div>
      <div class="flex gap-2">
        <p-button
          label="Ver Listado"
          icon="pi pi-list"
          [outlined]="true"
          severity="secondary"
          styleClass="ventas-pill"
          (onClick)="verListado()"
          pTooltip="Ver historial de ventas"
          tooltipPosition="bottom"
        />
        <p-button
          label="Nueva Venta"
          icon="pi pi-refresh"
          styleClass="ventas-pill ventas-pill-warning"
          (onClick)="nuevaVenta()"
          pTooltip="Reiniciar formulario"
          tooltipPosition="bottom"
          [disabled]="!comprobanteGenerado"
        />
      </div>
    </div>
  </p-card>
</div>

<!-- ========================================= -->
<!-- WIZARD CARD (4 PASOS) -->
<!-- ========================================= -->
<div class="p-2">
  <p-card styleClass="wizard-card">
    <!-- WIZARD STEPS -->
    <div class="wizard-steps">
      <div
        *ngFor="let step of steps; let i = index"
        class="wizard-step"
        [class.active]="activeStep === i"
        [class.completed]="activeStep > i"
      >
        <div class="step-number">
          <i *ngIf="activeStep > i" class="pi pi-check"></i>
          <span *ngIf="activeStep <= i">{{ i + 1 }}</span>
        </div>
        <div class="step-title">{{ step }}</div>
      </div>
    </div>

    <p-divider styleClass="wizard-divider" />

    <!-- WIZARD CONTENT -->
    <div class="wizard-content">
      <!-- ========================================= -->
      <!-- PASO 1: COMPROBANTE Y CLIENTE -->
      <!-- ========================================= -->
      <div *ngIf="activeStep === 0" class="step-content">
        <div class="step-header">
          <i class="pi pi-file-edit step-icon"></i>
          <h3>Datos del Comprobante y Cliente</h3>
        </div>

        <div class="content-centrado">
          <div class="comprobante-section">
            <label class="section-label">
              <i class="pi pi-file-edit"></i>
              Tipo de Comprobante
            </label>
            <div class="flex justify-content-center">
              <p-selectButton
                [(ngModel)]="tipoComprobante"
                [options]="tipoComprobanteOptions"
                optionLabel="label"
                optionValue="value"
                styleClass="select-comprobante-inline"
              >
                <ng-template let-item>
                  <div class="option-inline">
                    <i [class]="item.icon"></i>
                    <span>{{ item.label }}</span>
                  </div>
                </ng-template>
              </p-selectButton>
            </div>
          </div>

          <p-divider styleClass="section-divider" />

          <!-- Cliente -->
          <div class="cliente-section">
            <label class="section-label">
              <i class="pi pi-users"></i>
              Datos del Cliente
            </label>

            <!-- Buscar Cliente -->
            <div class="buscar-cliente-section">
              <label class="input-label">{{ tipoComprobante === '03' ? 'DNI' : 'RUC' }}</label>

              <div class="flex gap-2 align-items-center">
                <div style="flex: 1; min-width: 0">
                  <p-autocomplete
                    [(ngModel)]="clienteAutoComplete"
                    [suggestions]="clientesSugeridos"
                    (completeMethod)="buscarClienteAutoComplete($event)"
                    (onSelect)="onSelectCliente($event)"
                    (onClear)="onClearCliente()"
                    [placeholder]="
                      tipoComprobante === '03'
                        ? 'Ingrese DNI (8 dígitos)'
                        : 'Ingrese RUC (11 dígitos)'
                    "
                    [minLength]="3"
                    [forceSelection]="false"
                    [showEmptyMessage]="true"
                    emptyMessage="No se encontraron clientes"
                    dataKey="id_cliente"
                    optionLabel="num_doc"
                    styleClass="w-full autocomplete-clientes"
                  >
                    <ng-template let-cliente pTemplate="item">
                      <div class="flex align-items-center gap-3 p-2">
                        <i class="pi pi-user text-2xl" style="color: #f6af33"></i>
                        <div class="flex-1">
                          <div *ngIf="tipoComprobante === '03'">
                            <div class="font-bold">
                              {{ cliente.apellidos }} {{ cliente.nombres }}
                            </div>
                            <small class="text-600">DNI: {{ cliente.num_doc }}</small>
                          </div>

                          <div *ngIf="tipoComprobante === '01'">
                            <div class="font-bold">{{ cliente.razon_social }}</div>
                            <small class="text-600">RUC: {{ cliente.num_doc }}</small>
                          </div>
                        </div>
                      </div>
                    </ng-template>

                    <!-- ✅ Template para mostrar el valor seleccionado -->
                    <ng-template let-cliente pTemplate="selectedItem">
                      <span *ngIf="cliente">{{ cliente.num_doc }}</span>
                    </ng-template>
                  </p-autocomplete>
                </div>

                <div style="flex: 0 0 200px">
                  <p-button
                    label="Buscar"
                    icon="pi pi-search"
                    (onClick)="buscarCliente()"
                    [disabled]="
                      (!clienteAutoComplete && !numeroDocumento) ||
                      (clienteAutoComplete?.num_doc?.length || numeroDocumento?.length || 0) < 8
                    "
                    styleClass="w-full btn-buscar-cliente"
                  />
                </div>
              </div>
            </div>

            <!-- Cliente encontrado -->
            <div *ngIf="clienteEncontrado" class="cliente-encontrado-card mt-3">
              <p-card styleClass="cliente-card-success">
                <div class="cliente-content">
                  <!-- Línea 1: Nombre y Verificado -->
                  <div class="cliente-cabecera-row">
                    <div class="cliente-row">
                      <h4 class="cliente-nombre">
                        {{
                          tipoComprobante === '03'
                            ? clienteEncontrado.apellidos + ' ' + clienteEncontrado.nombres
                            : clienteEncontrado.razon_social
                        }}
                      </h4>
                      <span class="badge-verified">
                        <i class="pi pi-check-circle"></i>
                        Verificado
                      </span>
                      <p-button
                        icon="pi pi-times-circle"
                        [text]="true"
                        severity="secondary"
                        size="small"
                        (onClick)="limpiarCliente()"
                        pTooltip="Cambiar cliente"
                        tooltipPosition="left"
                        styleClass="btn-close-cliente"
                      />
                    </div>
                  </div>

                  <!-- Línea 2: DNI y Teléfono -->
                  <div class="cliente-row mt-3">
                    <span class="info-badge dni">
                      <i class="pi pi-id-card"></i>
                      {{ clienteEncontrado.tipo_doc }}: {{ clienteEncontrado.num_doc }}
                    </span>
                    <span class="info-badge telefono" *ngIf="clienteEncontrado.telefono">
                      <i class="pi pi-phone"></i>
                      {{ clienteEncontrado.telefono }}
                    </span>
                  </div>

                  <!-- Línea 3: Email -->
                  <div class="cliente-row mt-3" *ngIf="clienteEncontrado.email">
                    <span class="info-badge email">
                      <i class="pi pi-envelope"></i>
                      {{ clienteEncontrado.email }}
                    </span>
                  </div>

                  <!-- Línea 4: Dirección -->
                  <div class="cliente-row mt-3" *ngIf="clienteEncontrado.direccion">
                    <span class="info-badge direccion">
                      <i class="pi pi-map-marker"></i>
                      {{ clienteEncontrado.direccion }}
                    </span>
                  </div>
                </div>
              </p-card>
            </div>

            <!-- Registrar nuevo cliente -->
            <div *ngIf="mostrarFormulario" class="nuevo-cliente-form mt-3">
              <p-divider align="center">
                <span class="divider-text">
                  <i class="pi pi-user-plus mr-2"></i>
                  Cliente no encontrado - Registrar nuevo
                </span>
              </p-divider>

              <div class="form-grid">
                <!-- NOMBRES (solo para DNI) -->
                <div class="form-field" *ngIf="tipoComprobante === '03'">
                  <label>Nombres *</label>
                  <input
                    pInputText
                    [(ngModel)]="nuevoCliente.nombres"
                    placeholder="Ingresar Nombres"
                    class="w-full"
                  />
                </div>

                <!-- APELLIDOS (solo para DNI) -->
                <div class="form-field" *ngIf="tipoComprobante === '03'">
                  <label>Apellidos *</label>
                  <input
                    pInputText
                    [(ngModel)]="nuevoCliente.apellidos"
                    placeholder="Ingresar Apellidos"
                    class="w-full"
                  />
                </div>

                <!-- RAZÓN SOCIAL (solo para RUC) -->
                <div class="form-field full-width" *ngIf="tipoComprobante === '01'">
                  <label>Razón Social *</label>
                  <input
                    pInputText
                    [(ngModel)]="nuevoCliente.razon_social"
                    placeholder="Ingresa Razon Social."
                    class="w-full"
                  />
                </div>

                <!-- DIRECCIÓN -->
                <div class="form-field">
                  <label>Dirección</label>
                  <input
                    pInputText
                    [(ngModel)]="nuevoCliente.direccion"
                    placeholder="Ingrese Dirección"
                    class="w-full"
                  />
                </div>

                <!-- TELÉFONO -->
                <div class="form-field">
                  <label>Teléfono</label>
                  <input
                    pInputText
                    [(ngModel)]="nuevoCliente.telefono"
                    placeholder="Ingrese Teléfono"
                    class="w-full"
                    maxlength="9"
                  />
                </div>

                <!-- EMAIL -->
                <div class="form-field full-width">
                  <label>Email (opcional)</label>
                  <input
                    pInputText
                    [(ngModel)]="nuevoCliente.email"
                    placeholder="Ingrese Email"
                    class="w-full"
                    type="email"
                  />
                </div>

                <!-- BOTÓN REGISTRAR -->
                <div class="form-field full-width">
                  <p-button
                    label="Registrar Cliente"
                    icon="pi pi-user-plus"
                    (onClick)="registrarNuevoCliente()"
                    styleClass="w-full btn-registrar-cliente"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ========================================= -->
      <!-- PASO 2: PRODUCTOS -->
      <!-- ========================================= -->
      <div *ngIf="activeStep === 1" class="step-content">
        <div class="step-header">
          <i class="pi pi-box step-icon"></i>
          <h3>Seleccionar Productos</h3>
        </div>

        <div class="productos-container">
          <!-- Filtros -->
          <div class="filtros-productos mb-4">
            <!-- Autocomplete Buscar Producto -->
            <!-- Autocomplete Buscar Producto -->
            <div class="buscar-producto-auto">
              <label class="font-semibold mb-2 block">Buscar producto</label>
              <p-autocomplete
                [(ngModel)]="productoSeleccionadoBusqueda"
                [suggestions]="productosSugeridos"
                (completeMethod)="buscarProductos($event)"
                (onSelect)="onProductoSeleccionado($event)"
                (onClear)="onLimpiarBusqueda()"
                [dropdown]="true"
                placeholder="Buscar por nombre o código"
                [forceSelection]="false"
                [showEmptyMessage]="true"
                emptyMessage="No se encontraron productos"
                styleClass="w-full autocomplete-productos-search"
                [minLength]="2"
              >
                <ng-template let-producto pTemplate="item">
                  <div class="producto-suggestion">
                    <div class="suggestion-header">
                      <span class="suggestion-codigo">{{ producto.codigo }}</span>
                      <p-tag
                        [value]="producto.familia"
                        severity="info"
                        styleClass="suggestion-tag"
                      />
                    </div>
                    <div class="suggestion-nombre">{{ producto.nombre }}</div>
                    <div class="suggestion-precio">
                      S/. {{ producto.precioUnidad | number : '1.2-2' }}
                    </div>
                  </div>
                </ng-template>
              </p-autocomplete>
            </div>

            <!-- Selector de Familia -->
            <div class="familia-selector">
              <label class="font-semibold mb-2 block">Familia</label>
              <p-select
                [(ngModel)]="familiaSeleccionada"
                [options]="familiasDisponibles"
                (onChange)="onFamiliaChange()"
                placeholder="Todas las familias"
                [showClear]="true"
                styleClass="w-full"
                optionLabel="label"
                optionValue="value"
              >
                <ng-template pTemplate="selectedItem" let-option>
                  <div class="familia-option" *ngIf="option">
                    <i class="pi pi-tag"></i>
                    <span>{{ option.label }}</span>
                  </div>
                </ng-template>
                <ng-template let-option pTemplate="item">
                  <div class="familia-option">
                    <i class="pi pi-tag"></i>
                    <span>{{ option.label }}</span>
                  </div>
                </ng-template>
              </p-select>
            </div>

            <div class="sede-selector">
              <label class="font-semibold mb-2 block">Sede</label>
              <p-select
                [(ngModel)]="sedeSeleccionada"
                [options]="sedesDisponibles"
                (onChange)="onSedeChange()"
                placeholder="Seleccione una sede"
                optionLabel="label"
                optionValue="value"
                styleClass="w-full"
              >
                <ng-template pTemplate="selectedItem" let-option>
                  <div class="sede-option" *ngIf="option">
                    <i class="pi pi-building"></i>
                    <span>{{ option.label }}</span>
                  </div>
                </ng-template>
                <ng-template let-option pTemplate="item">
                  <div class="sede-option">
                    <i class="pi pi-building"></i>
                    <span>{{ option.label }}</span>
                  </div>
                </ng-template>
              </p-select>
            </div>
          </div>

          <!-- Grid Productos + Panel Agregar -->
          <div class="productos-grid mb-4">
            <!-- Lista productos -->
            <div class="productos-lista">
              <h4 class="mb-3">Productos Disponibles ({{ productosFiltrados.length }})</h4>
              <div class="productos-scroll">
                <div
                  *ngFor="let producto of productosFiltrados"
                  class="producto-item"
                  [class.selected]="productoTemp?.id === producto.id"
                  (click)="seleccionarProducto(producto)"
                >
                  <div class="flex justify-content-between align-items-center mb-2">
                    <span class="codigo">{{ producto.codigo }}</span>
                    <p-tag [value]="producto.familia" severity="info" />
                  </div>
                  <div class="producto-nombre mb-2">{{ producto.nombre }}</div>
                  <div class="producto-precios">
                    <small>
                      <strong>Unidad:</strong> S/. {{ producto.precioUnidad | number : '1.2-2' }}
                    </small>
                    <small>
                      <strong>Caja:</strong> S/. {{ producto.precioCaja | number : '1.2-2' }}
                    </small>
                    <small>
                      <strong>Mayorista:</strong> S/.
                      {{ producto.precioMayorista | number : '1.2-2' }}
                    </small>
                  </div>
                </div>

                <div *ngIf="productosFiltrados.length === 0" class="no-productos">
                  <i class="pi pi-inbox"></i>
                  <p>No se encontraron productos</p>
                </div>
              </div>
            </div>

            <!-- Panel agregar -->
            <div class="agregar-producto-panel">
              <h4 class="mb-3">Agregar al Carrito</h4>

              <div *ngIf="productoTemp" class="form-agregar">
                <div class="producto-seleccionado mb-3">
                  <strong class="block mb-1">{{ productoTemp.nombre }}</strong>
                  <small class="text-600">{{ productoTemp.codigo }}</small>
                </div>

                <div class="form-field mb-3">
                  <label class="block mb-2 font-semibold">Tipo de Precio</label>
                  <p-selectButton
                    [(ngModel)]="tipoPrecioTemp"
                    [options]="opcionesTipoPrecio"
                    optionLabel="label"
                    optionValue="value"
                    styleClass="w-full"
                  />
                </div>

                <div class="form-field mb-3">
                  <label class="block mb-2 font-semibold">Cantidad</label>
                  <p-inputNumber
                    [(ngModel)]="cantidadTemp"
                    [min]="1"
                    [showButtons]="true"
                    styleClass="w-full"
                  />
                </div>

                <div class="precio-display mb-3">
                  <span>Precio Unitario</span>
                  <span class="precio-valor">
                    S/. {{ getPrecioSegunTipo(productoTemp) | number : '1.2-2' }}
                  </span>
                </div>

                <div class="total-display mb-3">
                  <span>Total</span>
                  <span class="total-valor">
                    S/. {{ getPrecioSegunTipo(productoTemp) * cantidadTemp | number : '1.2-2' }}
                  </span>
                </div>

                <p-button
                  label="Agregar"
                  icon="pi pi-plus"
                  (onClick)="agregarProducto()"
                  styleClass="w-full btn-agregar-producto"
                />
              </div>

              <div *ngIf="!productoTemp" class="no-seleccion">
                <i class="pi pi-hand-pointer"></i>
                <p>Seleccione un producto</p>
              </div>
            </div>
          </div>

          <!-- Carrito -->
          <div class="carrito-section">
            <p-divider />
            <h4 class="flex align-items-center gap-2 mb-3">
              <i class="pi pi-shopping-cart"></i>
              Carrito de Compras ({{ productosSeleccionados.length }} items)
            </h4>

            <p-table
              *ngIf="productosSeleccionados.length > 0"
              [value]="productosSeleccionados"
              styleClass="p-datatable-sm"
            >
              <ng-template pTemplate="header">
                <tr>
                  <th>Código</th>
                  <th>Producto</th>
                  <th class="text-right">Cantidad</th>
                  <th class="text-right">Precio Unit.</th>
                  <th class="text-right">Subtotal</th>
                  <th style="width: 5rem"></th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
                <tr>
                  <td>{{ item.cod_prod }}</td>
                  <td>{{ item.descripcion }}</td>
                  <td class="text-right">{{ item.cantidad }}</td>
                  <td class="text-right">S/. {{ item.pre_uni | number : '1.2-2' }}</td>
                  <td class="text-right">
                    S/. {{ item.pre_uni * item.cantidad | number : '1.2-2' }}
                  </td>
                  <td class="text-center">
                    <p-button
                      icon="pi pi-trash"
                      severity="danger"
                      [text]="true"
                      [rounded]="true"
                      (onClick)="eliminarProducto(rowIndex)"
                    />
                  </td>
                </tr>
              </ng-template>
            </p-table>

            <div *ngIf="productosSeleccionados.length > 0" class="totales-carrito mt-3">
              <div class="total-line">
                <span>Subtotal:</span>
                <span>S/. {{ calcularSubtotal() | number : '1.2-2' }}</span>
              </div>
              <div class="total-line">
                <span>IGV (18%):</span>
                <span>S/. {{ calcularIGV() | number : '1.2-2' }}</span>
              </div>
              <div class="total-line total-final">
                <span>TOTAL:</span>
                <span>S/. {{ calcularTotal() | number : '1.2-2' }}</span>
              </div>
            </div>

            <div *ngIf="productosSeleccionados.length === 0" class="carrito-vacio">
              <i class="pi pi-shopping-cart"></i>
              <p>El carrito está vacío</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ========================================= -->
      <!-- PASO 3: VENTA Y PAGO -->
      <!-- ========================================= -->
      <div *ngIf="activeStep === 2" class="step-content">
        <div class="step-header">
          <i class="pi pi-credit-card step-icon"></i>
          <h3>Modalidad y Forma de Pago</h3>
        </div>

        <div class="content-centrado">
          <!-- Tipo de Venta -->
          <div class="tipo-venta-section mb-4">
            <label class="section-label">
              <i class="pi pi-send"></i>
              Tipo de Venta
            </label>

            <p-selectButton
              [(ngModel)]="tipoVenta"
              [options]="tipoVentaOptions"
              optionLabel="label"
              optionValue="value"
              styleClass="select-inline"
            >
              <ng-template let-item>
                <div class="option-inline">
                  <i [class]="item.icon"></i>
                  <span>{{ item.label }}</span>
                </div>
              </ng-template>
            </p-selectButton>

            <div *ngIf="tipoVenta === 'ENVIO'" class="mt-3">
              <label class="input-label">Departamento de Envío *</label>
              <input
                pInputText
                [(ngModel)]="departamento"
                placeholder="Ej: Lima, Arequipa, Cusco"
                class="w-full"
              />
            </div>
          </div>

          <p-divider styleClass="section-divider" />

          <!-- Método de Pago -->
          <div class="tipo-pago-section">
            <label class="section-label">
              <i class="pi pi-wallet"></i>
              Método de Pago
            </label>

            <div class="metodos-pago-grid">
              <div
                *ngFor="let metodo of tipoPagoOptions"
                class="metodo-pago-card"
                [class.selected]="tipoPago === metodo.value"
                (click)="tipoPago = metodo.value"
              >
                <div class="metodo-icon">
                  <i [class]="metodo.icon"></i>
                </div>
                <span class="metodo-label">{{ metodo.label }}</span>
                <div class="check-indicator" *ngIf="tipoPago === metodo.value">
                  <i class="pi pi-check"></i>
                </div>
              </div>
            </div>

            <!-- Detalles Efectivo -->
            <div *ngIf="tipoPago === 'EFECTIVO'" class="pago-detalles mt-4">
              <div class="total-a-pagar mb-3">
                <span>Total a Pagar:</span>
                <span class="monto-total">S/. {{ calcularTotal() | number : '1.2-2' }}</span>
              </div>

              <div class="form-field mb-3">
                <label class="input-label">Monto Recibido *</label>
                <p-inputNumber
                  [(ngModel)]="montoRecibido"
                  mode="currency"
                  currency="PEN"
                  locale="es-PE"
                  [min]="0"
                  styleClass="w-full"
                />
              </div>

              <div *ngIf="montoRecibido >= calcularTotal()" class="vuelto-display">
                <span>Vuelto:</span>
                <span class="vuelto-valor">S/. {{ calcularVuelto() | number : '1.2-2' }}</span>
              </div>
            </div>

            <!-- Detalles Tarjeta -->
            <div *ngIf="tipoPago === 'TARJETA'" class="pago-detalles mt-4">
              <div class="form-field mb-3">
                <label class="input-label">Seleccione Banco *</label>
                <p-selectButton
                  [(ngModel)]="bancoSeleccionado"
                  [options]="bancosDisponibles"
                  styleClass="w-full"
                />
              </div>

              <div class="form-field">
                <label class="input-label">Número de Operación</label>
                <input
                  pInputText
                  [(ngModel)]="numeroOperacion"
                  placeholder="Ingrese número de operación"
                  class="w-full"
                />
              </div>
            </div>

            <!-- Detalles Yape/Plin -->
            <div *ngIf="tipoPago === 'YAPE' || tipoPago === 'PLIN'" class="pago-detalles mt-4">
              <div class="total-a-pagar mb-3">
                <span>Monto a Pagar:</span>
                <span class="monto-total">S/. {{ calcularTotal() | number : '1.2-2' }}</span>
              </div>

              <p-message
                severity="info"
                [text]="'Pago mediante ' + tipoPago"
                styleClass="w-full mb-3"
              />

              <div class="form-field">
                <label class="input-label">Número de Operación (Opcional)</label>
                <input
                  pInputText
                  [(ngModel)]="numeroOperacion"
                  placeholder="Ingrese número de operación"
                  class="w-full"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ========================================= -->
      <!-- PASO 4: CONFIRMACIÓN -->
      <!-- ========================================= -->
      <div *ngIf="activeStep === 3" class="step-content">
        <!-- Confirmación -->
        <div *ngIf="!comprobanteGenerado">
          <div class="step-header">
            <i class="pi pi-check-circle step-icon"></i>
            <h3>Confirmar Venta</h3>
          </div>

          <div class="content-centrado">
            <p-card styleClass="resumen-venta">
              <h4 class="mb-4">Resumen de la Venta</h4>

              <div class="resumen-grid mb-4">
                <div class="resumen-item">
                  <span class="label">Tipo de Comprobante:</span>
                  <p-tag
                    [value]="tipoComprobante === '03' ? 'BOLETA' : 'FACTURA'"
                    severity="info"
                  />
                </div>

                <div class="resumen-item">
                  <span class="label">Cliente:</span>
                  <strong>{{
                    clienteEncontrado?.nombres || clienteEncontrado?.razon_social
                  }}</strong>
                </div>

                <div class="resumen-item">
                  <span class="label">Documento:</span>
                  <strong>{{ clienteEncontrado?.num_doc }}</strong>
                </div>

                <div class="resumen-item">
                  <span class="label">Productos:</span>
                  <strong>{{ productosSeleccionados.length }} items</strong>
                </div>

                <div class="resumen-item">
                  <span class="label">Tipo de Venta:</span>
                  <strong>{{ tipoVenta }}</strong>
                </div>

                <div class="resumen-item">
                  <span class="label">Método de Pago:</span>
                  <strong>{{ tipoPago }}</strong>
                </div>
              </div>

              <p-divider />

              <div class="resumen-totales">
                <div class="total-line">
                  <span>Subtotal:</span>
                  <span>S/. {{ calcularSubtotal() | number : '1.2-2' }}</span>
                </div>
                <div class="total-line">
                  <span>IGV (18%):</span>
                  <span>S/. {{ calcularIGV() | number : '1.2-2' }}</span>
                </div>
                <div class="total-line total-final">
                  <span>TOTAL:</span>
                  <span>S/. {{ calcularTotal() | number : '1.2-2' }}</span>
                </div>
              </div>
            </p-card>

            <div class="mt-4">
              <p-button
                label="Generar Venta"
                icon="pi pi-check"
                [loading]="loading"
                (onClick)="generarVenta()"
                styleClass="w-full btn-generar-venta"
              />
            </div>
          </div>
        </div>

        <!-- Venta Exitosa -->
        <div *ngIf="comprobanteGenerado" class="venta-exitosa">
          <div class="success-animation">
            <i class="pi pi-check-circle"></i>
          </div>
          <h2 class="mb-4">¡Venta Generada Exitosamente!</h2>

          <p-card styleClass="comprobante-info-card">
            <div class="flex justify-content-between align-items-center mb-3">
              <h3 class="m-0">
                {{ comprobanteGenerado.serie }}-{{
                  comprobanteGenerado.numero.toString().padStart(8, '0')
                }}
              </h3>
              <p-tag
                [value]="comprobanteGenerado.tipo_comprobante === '03' ? 'BOLETA' : 'FACTURA'"
                severity="success"
              />
            </div>

            <p-divider />

            <div class="info-grid">
              <div class="info-item">
                <span class="label">Cliente:</span>
                <strong>{{ comprobanteGenerado.cliente_nombre }}</strong>
              </div>
              <div class="info-item">
                <span class="label">Documento:</span>
                <strong>{{ comprobanteGenerado.cliente_doc }}</strong>
              </div>
              <div class="info-item">
                <span class="label">Fecha:</span>
                <strong>{{ comprobanteGenerado.fec_emision | date : 'dd/MM/yyyy HH:mm' }}</strong>
              </div>
              <div class="info-item">
                <span class="label">Monto Total:</span>
                <strong class="monto-total">
                  S/. {{ comprobanteGenerado.total | number : '1.2-2' }}
                </strong>
              </div>
            </div>
          </p-card>

          <div class="action-buttons-final mt-4">
            <p-button
              label="Imprimir Comprobante"
              icon="pi pi-print"
              (onClick)="imprimirComprobante()"
              styleClass="w-full"
            />
            <p-button
              label="Nueva Venta"
              icon="pi pi-plus"
              severity="success"
              (onClick)="nuevaVenta()"
              styleClass="w-full"
            />
            <p-button
              label="Ver Listado"
              icon="pi pi-list"
              [outlined]="true"
              (onClick)="verListado()"
              styleClass="w-full"
            />
          </div>
        </div>
      </div>
    </div>

    <p-divider styleClass="wizard-divider" />

    <!-- NAVEGACIÓN -->
    <div *ngIf="activeStep < 3 || !comprobanteGenerado" class="step-actions">
      <p-button
        *ngIf="activeStep > 0"
        label="Anterior"
        icon="pi pi-arrow-left"
        [outlined]="true"
        severity="secondary"
        (onClick)="prevStep()"
      />
      <span *ngIf="activeStep === 0"></span>
      <p-button
        *ngIf="activeStep < 3"
        label="Siguiente"
        icon="pi pi-arrow-right"
        iconPos="right"
        severity="primary"
        (onClick)="nextStep()"
      />
    </div>
  </p-card>
</div>

<p-toast />
<p-confirmDialog />
