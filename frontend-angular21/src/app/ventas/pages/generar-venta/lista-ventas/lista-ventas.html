<div class="lista-ventas-container">

  <div class="header-section">
    <div class="header-content">
      <h1><i class="pi pi-list"></i> Listado de Ventas</h1>
      <div class="header-actions">
        <p-button 
          label="Nueva Venta" 
          icon="pi pi-plus"
          severity="success"
          (onClick)="nuevaVenta()"
        />
        <p-button 
          label="Volver" 
          icon="pi pi-arrow-left"
          [outlined]="true"
          (onClick)="volver()"
        />
      </div>
    </div>
  </div>

  <p-card styleClass="filtros-card">
    <div class="filtros-container">
      <div class="filtros-row">
        <div class="filtro-item">
          <label>Buscar</label>
          <p-iconfield iconPosition="left">
            <p-inputicon styleClass="pi pi-search" />
            <input 
              pInputText 
              [(ngModel)]="busqueda" 
              (ngModelChange)="aplicarFiltros()"
              placeholder="N° comprobante, cliente o documento"
              class="w-full"
            />
          </p-iconfield>
        </div>

        <div class="filtro-item">
          <label>Fecha Inicio</label>
          <p-datepicker 
            [(ngModel)]="fechaInicio"
            (ngModelChange)="aplicarFiltros()"
            dateFormat="dd/mm/yy"
            [showIcon]="true"
            placeholder="Seleccione fecha"
            styleClass="w-full"
          />
        </div>

        <div class="filtro-item">
          <label>Fecha Fin</label>
          <p-datepicker 
            [(ngModel)]="fechaFin"
            (ngModelChange)="aplicarFiltros()"
            dateFormat="dd/mm/yy"
            [showIcon]="true"
            placeholder="Seleccione fecha"
            styleClass="w-full"
          />
        </div>
      </div>

      <div class="filtros-row">
        <div class="filtro-item">
          <label>Tipo de Comprobante</label>
          <p-selectButton 
            [(ngModel)]="tipoComprobanteSeleccionado"
            [options]="tipoComprobanteOptions"
            (ngModelChange)="aplicarFiltros()"
            optionLabel="label"
            optionValue="value"
            styleClass="w-full"
          />
        </div>

        <div class="filtro-item">
          <label>Estado</label>
          <p-selectButton 
            [(ngModel)]="estadoSeleccionado"
            [options]="estadoOptions"
            (ngModelChange)="aplicarFiltros()"
            optionLabel="label"
            optionValue="value"
            styleClass="w-full"
          />
        </div>

        <div class="filtro-item filtro-actions">
          <p-button 
            label="Limpiar Filtros" 
            icon="pi pi-filter-slash"
            [outlined]="true"
            (onClick)="limpiarFiltros()"
            styleClass="w-full"
          />
        </div>
      </div>
    </div>
  </p-card>

  <p-card styleClass="estadisticas-card">
    <div class="estadisticas-grid">
      <div class="stat-item total">
        <i class="pi pi-dollar"></i>
        <div class="stat-content">
          <span class="stat-label">Total Ventas</span>
          <span class="stat-value">S/. {{ totalVentas | number:'1.2-2' }}</span>
        </div>
      </div>
      <div class="stat-item facturas">
        <i class="pi pi-file"></i>
        <div class="stat-content">
          <span class="stat-label">Facturas</span>
          <span class="stat-value">S/. {{ totalFacturado | number:'1.2-2' }}</span>
        </div>
      </div>
      <div class="stat-item boletas">
        <i class="pi pi-receipt"></i>
        <div class="stat-content">
          <span class="stat-label">Boletas</span>
          <span class="stat-value">S/. {{ totalBoletas | number:'1.2-2' }}</span>
        </div>
      </div>
      <div class="stat-item count">
        <i class="pi pi-list"></i>
        <div class="stat-content">
          <span class="stat-label">Comprobantes</span>
          <span class="stat-value">{{ ventasFiltradas.length }}</span>
        </div>
      </div>
    </div>
  </p-card>

  <p-card styleClass="tabla-card">
    <p-table 
      [value]="ventasFiltradas.slice(first, first + rows)"
      [loading]="loading"
      styleClass="ventas-table"
      [tableStyle]="{'min-width': '60rem'}"
    >
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 10rem;">N° Comprobante</th>
          <th style="width: 8rem;">Tipo</th>
          <th style="width: 10rem;">Fecha</th>
          <th>Cliente</th>
          <th style="width: 10rem;">Documento</th>
          <th style="text-align: right; width: 10rem;">Total</th>
          <th style="width: 8rem;">Estado</th>
          <th style="width: 12rem; text-align: center;">Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-venta>
        <tr>
          <td><strong>{{ venta.serie }}-{{ venta.numero.toString().padStart(8, '0') }}</strong></td>
          <td>
            <p-tag 
              [value]="venta.tipo_comprobante === '03' ? 'BOLETA' : 'FACTURA'" 
              [severity]="getSeverityTipoComprobante(venta.tipo_comprobante)"
            />
          </td>
          <td>{{ venta.fec_emision | date:'dd/MM/yyyy HH:mm' }}</td>
          <td>{{ venta.cliente_nombre || 'Sin nombre' }}</td>
          <td>{{ venta.cliente_doc }}</td>
          <td style="text-align: right;"><strong>S/. {{ venta.total | number:'1.2-2' }}</strong></td>
          <td>
            <p-tag 
              [value]="venta.estado ? 'EMITIDO' : 'ANULADO'" 
              [severity]="getSeverityEstado(venta.estado)"
            />
          </td>
          <td style="text-align: center;">
            <p-button 
              icon="pi pi-eye" 
              [rounded]="true"
              [text]="true"
              severity="info"
              pTooltip="Ver Detalle"
              tooltipPosition="top"
              (onClick)="verDetalle(venta)"
            />
            <p-button 
              icon="pi pi-print" 
              [rounded]="true"
              [text]="true"
              severity="secondary"
              pTooltip="Imprimir"
              tooltipPosition="top"
              (onClick)="imprimirComprobante(venta)"
            />
            <p-button 
              icon="pi pi-ban" 
              [rounded]="true"
              [text]="true"
              severity="danger"
              pTooltip="Anular"
              tooltipPosition="top"
              [disabled]="!venta.estado"
              (onClick)="anularVenta(venta)"
            />
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="text-center empty-message">
            <i class="pi pi-inbox" style="font-size: 3rem; color: #6B7280; margin-bottom: 1rem;"></i>
            <p style="margin: 0; color: #6B7280;">No se encontraron ventas</p>
          </td>
        </tr>
      </ng-template>
    </p-table>

    <div class="paginador-container">
      <div class="paginador-info">
        <span>Mostrando {{ first + 1 }} - {{ Math.min(first + rows, totalRecords) }} de {{ totalRecords }} registros</span>
      </div>
      <p-paginator 
        [first]="first" 
        [rows]="rows" 
        [totalRecords]="totalRecords"
        [rowsPerPageOptions]="[5,10,25,50]"
        (onPageChange)="onPageChange($event)"
      />
    </div>
  </p-card>

</div>

<p-toast />
<p-confirmDialog />
