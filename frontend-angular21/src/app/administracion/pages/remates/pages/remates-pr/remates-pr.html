<div class="clientes-page">
  <p-card styleClass="clientes-header-card">
    <div class="flex align-items-center justify-content-between flex-wrap gap-3">
      <div class="flex align-items-center gap-3">
        <span class="clientes-title-icon"><i class="pi pi-list"></i></span>
        <div>
          <p class="clientes-kicker">ADMINISTRADOR · ADMINISTRACIÓN - REMATES</p>
          <h2 class="clientes-title">REMATES</h2>
        </div>
      </div>
      <div class="flex align-items-center gap-2">
        <p-button (onClick)="abrirModal()" label="Registro Remate" icon="pi pi-plus" styleClass="clientes-pill"></p-button>
      </div>
    </div>
  </p-card>

  <div class="grid mb-4 mermas-metrics">
    <div class="col-12 md:col-4">
      <p-card styleClass="stat-card">
        <div class="stat-card-content">
          <i class="pi pi-dollar stat-icon"></i>
          <div>
            <p class="stat-label">TOTAL REMATES</p>
            <h3 class="stat-value">{{ totalRemates() }}</h3>
            <p class="stat-change">+8 nuevos hoy</p>
          </div>
        </div>
      </p-card>
    </div>

    <div class="col-12 md:col-4">
      <p-card styleClass="stat-card">
        <div class="stat-card-content">
          <i class="pi pi-chart-line stat-icon"></i>
          <div>
            <p class="stat-label">VALOR TOTAL</p>
            <h3 class="stat-value">S/ {{ valorTotalRemates() | number:'1.2-2' }}</h3>
            <p class="stat-change">Precio de remate acumulado</p>
          </div>
        </div>
      </p-card>
    </div>
  </div>

  <!-- Filtros -->
  <p-card styleClass="filtros-card">
    <div class="grid">
      <div class="col-12 md:col-8">
        <label class="filter-label">Buscar Producto</label>
        <span class="p-input-icon-left ">
          <input pInputText type="text" placeholder="Escribe código o producto..." class="w-full"
            [ngModel]="busqueda()" (ngModelChange)="busqueda.set($event)" />
        </span>
      </div>

      <div class="col-12 md:col-4">
        <label class="filter-label" style="visibility: hidden;">Acción</label>
        <p-button label="Limpiar Filtros" icon="pi pi-filter-slash" [outlined]="true" severity="danger"
          styleClass="w-full" (onClick)="busqueda.set('')">
        </p-button>
      </div>
    </div>
  </p-card>

  <!-- Tabla -->
  <p-card styleClass="tabla-card">
    <div class="flex align-items-center justify-content-between mb-3">
      <div class="flex align-items-center gap-2">
        <span class="tabla-icon"><i class="pi pi-table"></i></span>
        <h3 class="tabla-title mb-0">REMATES REGISTRADOS</h3>
        <p-tag *ngIf="productosFiltrados().length > 0" [value]="productosFiltrados().length + ' items'" severity="info"></p-tag>
      </div>
    </div>

    <p-table
      [value]="productosFiltrados()"
      [tableStyle]="{ 'min-width': '100%' }"
      styleClass="mermas-table"
      [paginator]="true"
      [rows]="productosPorPagina()"
      [rowsPerPageOptions]="[5,10,20,50]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} productos"
      [loading]="cargando()">
      
      <ng-template #header>
        <tr>
          <th style="width: 12%">CÓDIGO</th>
          <th style="width: 40%">PRODUCTO</th>
          <th style="width: 12%">CANTIDAD</th>
          <th style="width: 18%">PRECIO REMATE</th>
          <th style="width: 8%" class="text-center">ACCIONES</th>
        </tr>
      </ng-template>

      <ng-template #body let-producto>
        <tr>
          <td>
            <span class="codigo-producto">{{ producto.codigo }}</span>
            <div class="fecha-producto">{{ producto.fechaRegistro | date:'dd/MM/yyyy' }}</div>
          </td>
          <td>
            <div class="producto-info">
              <div class="producto-nombre">{{ producto.nombre }}</div>
              <div class="producto-responsable">Responsable: {{ producto.responsable }}</div>
            </div>
          </td>
          <td>
            <span class="cantidad-badge">{{ producto.cantidad }} unid.</span>
          </td>
          <td>
            <span class="precio-remate">S/ {{ producto.precioRemate | number:'1.2-2' }}</span>
          </td>
          <td class="text-center">
            <p-button icon="pi pi-pencil" [text]="true" severity="info" styleClass="action-btn"
              (onClick)="editarProducto(producto)"></p-button>
          </td>
        </tr>
      </ng-template>

      <ng-template #emptymessage>
        <tr>
          <td colspan="5" class="text-center py-5">
            <i class="pi pi-inbox text-4xl text-400 mb-3"></i>
            <p class="text-500 mt-2">No hay remates registrados.</p>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Modal: usamos one-way + event para la visibilidad -->
  <p-dialog [visible]="mostrarModal()" (visibleChange)="mostrarModal.set($event)" [header]="modoEdicion() ? 'Editar Remate' : 'Registrar Remate'"
    [modal]="true" [style]="{width: '600px'}" [draggable]="false" [resizable]="false" styleClass="mermas-dialog">

    <div class="grid form-grid">
      <div class="col-12">
        <label class="field-label" for="codigoRemate">CÓDIGO DE REMATE <span class="required-asterisk">*</span></label>
        <input id="codigoRemate" pInputText class="w-full" [ngModel]="productoActual().codigoRemate" (ngModelChange)="setProductoField('codigoRemate',$event)" />
      </div>

      <div class="col-12">
        <label class="field-label" for="nombre">NOMBRE DEL PRODUCTO <span class="required-asterisk">*</span></label>
        <input id="nombre" pInputText class="w-full" [ngModel]="productoActual().nombre" (ngModelChange)="setProductoField('nombre',$event)" />
      </div>

      <div class="col-6">
        <label class="field-label" for="cantidad">CANTIDAD <span class="required-asterisk">*</span></label>
        <p-inputNumber [ngModel]="productoActual().cantidad" (ngModelChange)="setProductoField('cantidad',$event)" [min]="1" [showButtons]="true"></p-inputNumber>
      </div>

      <div class="col-6">
        <label class="field-label" for="precioRemate">PRECIO DE REMATE <span class="required-asterisk">*</span></label>
        <p-inputNumber [ngModel]="productoActual().precioRemate" (ngModelChange)="setProductoField('precioRemate',$event)" mode="currency" currency="PEN" locale="es-PE" [minFractionDigits]="2" [maxFractionDigits]="2"></p-inputNumber>
      </div>

      <div class="col-6">
        <label class="field-label" for="productId">PRODUCT ID (Interno) <span class="required-asterisk">*</span></label>
        <input id="productId" pInputText class="w-full" [ngModel]="productoActual().productId" (ngModelChange)="setProductoField('productId',$event)" placeholder="ID numérico del producto (ej: 6)" />
      </div>

      <div class="col-6">
        <label class="field-label" for="almacen">ALMACÉN <span class="required-asterisk">*</span></label>
        <select class="p-inputtext w-full" [ngModel]="productoActual().id_almacen_ref" (ngModelChange)="setProductoField('id_almacen_ref',$event)">
          <option *ngFor="let a of almacenes" [ngValue]="a.id">{{ a.name }}</option>
        </select>
      </div>

      <div class="col-12">
        <label class="field-label" for="responsable">RESPONSABLE <span class="required-asterisk">*</span></label>
        <input id="responsable" pInputText class="w-full" [ngModel]="productoActual().responsable" (ngModelChange)="setProductoField('responsable',$event)" placeholder="Ej: Jefatura de almacén" />
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="flex justify-content-center gap-2 mt-3">
        <p-button label="Cancelar" icon="pi pi-times" [outlined]="true" severity="secondary" (onClick)="cerrarModal()"></p-button>
        <p-button [label]="modoEdicion() ? 'Actualizar' : 'Guardar Remate'" icon="pi pi-check" styleClass="mermas-btn-primary" (onClick)="guardarProducto()"></p-button>
      </div>
    </ng-template>
  </p-dialog>

  <p-toast />
  <p-confirmDialog />
</div>