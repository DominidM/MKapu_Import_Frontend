<div class="registro-page">
  <!-- Header Card -->
  <p-card styleClass="registro-header-card">
    <div class="flex align-items-center justify-content-between flex-wrap gap-3">
      <div class="flex align-items-center gap-3">
        <span class="registro-title-icon">
          <i class="pi pi-file-edit"></i>
        </span>
        <div>
          <p class="registro-kicker">ALMACEN - MERMAS / REMATES</p>
          <h2 class="registro-title">REGISTRO DE PRODUCTO</h2>
        </div>
      </div>
      <p-button
        icon="pi pi-arrow-left"
        label="Volver"
        [outlined]="true"
        severity="secondary"
        [routerLink]="['/admin/mermas-remates']"
      ></p-button>
    </div>
  </p-card>

  <div class="grid">
    <!-- PASO 1 -->
    <div class="col-12">
      <p-card styleClass="form-card">
        <div class="section-header">
          <div class="section-number">1</div>
          <div>
            <h3 class="section-title">Tipo de Registro</h3>
            <p class="section-subtitle">Seleccione si el producto será clasificado como merma o remate</p>
          </div>
        </div>

        <div class="tipo-selector">
          <div
            class="tipo-option"
            [class.selected]="tipoRegistro === 'merma'"
            (click)="tipoRegistro = 'merma'; onTipoChange()"
          >
            <div class="tipo-icon tipo-icon-merma">
              <i class="pi pi-exclamation-triangle"></i>
            </div>
            <div class="tipo-content">
              <h4 class="tipo-title">Merma</h4>
              <p class="tipo-description">
                El producto sale del stock de manera definitiva debido a daños, vencimiento u otras causas
              </p>
            </div>
            <div class="tipo-radio">
              <p-radioButton name="tipo" value="merma" [(ngModel)]="tipoRegistro" (onClick)="onTipoChange()"></p-radioButton>
            </div>
          </div>

          <div
            class="tipo-option"
            [class.selected]="tipoRegistro === 'remate'"
            (click)="tipoRegistro = 'remate'; onTipoChange()"
          >
            <div class="tipo-icon tipo-icon-remate">
              <i class="pi pi-dollar"></i>
            </div>
            <div class="tipo-content">
              <h4 class="tipo-title">Remate</h4>
              <p class="tipo-description">
                El producto permanece en stock pero se ofrece a precio reducido para liquidación o promoción
              </p>
            </div>
            <div class="tipo-radio">
              <p-radioButton name="tipo" value="remate" [(ngModel)]="tipoRegistro" (onClick)="onTipoChange()"></p-radioButton>
            </div>
          </div>
        </div>
      </p-card>
    </div>

    <!-- PASO 2 -->
    <div class="col-12" *ngIf="tipoRegistro">
      <p-card styleClass="form-card">
        <div class="section-header">
          <div class="section-number">2</div>
          <div>
            <h3 class="section-title">Información del Producto</h3>
            <p class="section-subtitle">Busque el producto por código (ej: R6602) y especifique la cantidad</p>
          </div>
        </div>

        <div class="grid">
          <div class="col-12 md:col-8">
            <label class="field-label" for="codigoProducto">
              PRODUCTO (CÓDIGO) <span class="required-asterisk">*</span>
            </label>

            <div class="flex align-items-center gap-2">
              <input
                pInputText
                id="codigoProducto"
                [(ngModel)]="codigoProducto"
                class="w-full codigo-uppercase"
                placeholder="Ej: R6601"
                autocomplete="off"
                (input)="codigoProducto = (codigoProducto || '').toUpperCase()"
                (keydown.enter)="buscarProductoPorCodigo()"
              />

              <p-button
                type="button"
                icon="pi pi-search"
                label="Buscar"
                (onClick)="buscarProductoPorCodigo()"
              ></p-button>
            </div>

            <div class="mt-2" *ngIf="productoNoEncontrado">
              <small class="p-error">No hay producto con el código ingresado.</small>
            </div>

            <div *ngIf="productoSeleccionado" class="producto-info-card mt-3">
              <div class="producto-info-row">
                <span class="info-label">Código:</span>
                <span class="info-value">{{ productoSeleccionado.codigo }}</span>
              </div>

              <div class="producto-info-row">
                <span class="info-label">Producto:</span>
                <span class="info-value">{{ productoSeleccionado.anexo }}</span>
              </div>

              <div class="producto-info-row">
                <span class="info-label">Categoría:</span>
                <span class="info-value">{{ productoSeleccionado.categoriaNombre }}</span>
              </div>

              <div class="producto-info-row">
                <span class="info-label">Stock disponible:</span>
                <span class="info-value stock-value">
                  {{ (productoSeleccionado.stock ?? 0) }} unidades
                </span>
              </div>

              <div class="producto-info-row">
                <span class="info-label">Precio unitario:</span>
                <span class="info-value precio-value">
                  S/ {{ productoSeleccionado.pre_unit | number:'1.2-2' }}
                </span>
              </div>
            </div>
          </div>

          <div class="col-12 md:col-4">
            <label class="field-label" for="cantidad">
              CANTIDAD <span class="required-asterisk">*</span>
            </label>

            <p-inputNumber
              [(ngModel)]="cantidad"
              [min]="1"
              [max]="productoSeleccionado?.stock || 0"
              [style]="{ width: '100%' }"
              [showButtons]="true"
              buttonLayout="vertical"
              incrementButtonIcon="pi pi-plus"
              decrementButtonIcon="pi pi-minus"
              styleClass="cantidad-input"
            ></p-inputNumber>

            <small class="field-hint" *ngIf="productoSeleccionado">
              Máximo: {{ (productoSeleccionado.stock ?? 0) }} unidades
            </small>
          </div>
        </div>
      </p-card>
    </div>

    <!-- PASO 3 -->
    <div class="col-12" *ngIf="tipoRegistro && productoSeleccionado">
      <p-card styleClass="form-card">
        <div class="section-header">
          <div class="section-number">3</div>
          <div>
            <h3 class="section-title">Motivo y Observaciones</h3>
            <p class="section-subtitle">
              Especifique el motivo del {{ tipoRegistro === 'merma' ? 'descarte' : 'remate' }}
            </p>
          </div>
        </div>

        <div class="grid">
          <div class="col-12">
            <label class="field-label" for="motivo">
    MOTIVO <span class="required-asterisk">*</span>
    </label>

    <p-select
    inputId="motivo"
    [(ngModel)]="motivo"
    [options]="tipoRegistro === 'merma' ? motivosMerma : motivosRemate"
    optionLabel="label"
    optionValue="value"
    placeholder="Seleccione un motivo"
    [showClear]="true"
    styleClass="w-full"
    ></p-select>
          </div>

          <div class="col-12">
            <label class="field-label" for="observaciones">OBSERVACIONES</label>
            <textarea
              pInputTextarea
              [(ngModel)]="observaciones"
              rows="4"
              class="w-full"
              placeholder="Agregue detalles adicionales sobre el motivo del registro (opcional)"
            ></textarea>
          </div>

          <!-- RESPONSABLE: viene de usuario logeado (solo lectura) -->
          <div class="col-12">
            <label class="field-label">RESPONSABLE</label>
            <input
              pInputText
              class="w-full"
              [value]="responsableNombre"
              readonly
              placeholder="Se obtiene del usuario logeado"
            />
            <small class="field-hint">Se toma automáticamente del usuario en sesión</small>
          </div>
        </div>
      </p-card>
    </div>

    <!-- PASO 4 -->
    <div class="col-12" *ngIf="tipoRegistro === 'remate' && productoSeleccionado">
      <p-card styleClass="form-card remate-card">
        <div class="section-header">
          <div class="section-number">4</div>
          <div>
            <h3 class="section-title">Información de Remate</h3>
            <p class="section-subtitle">Configure el código y precio de remate del producto</p>
          </div>
        </div>

        <div class="grid">
          <div class="col-12 md:col-6">
            <label class="field-label" for="codigoRemate">
              CÓDIGO DE REMATE <span class="required-asterisk">*</span>
            </label>
            <input pInputText [(ngModel)]="codigoRemate" class="w-full codigo-remate-input" placeholder="Ej: RMT-2026-001" />
            <small class="field-hint">Este código identificará el producto en remate</small>
          </div>

          <div class="col-12 md:col-6">
            <label class="field-label" for="precioRemate">
              PRECIO DE REMATE <span class="required-asterisk">*</span>
            </label>
            <p-inputNumber
              [(ngModel)]="precioRemate"
              mode="currency"
              currency="PEN"
              locale="es-PE"
              [minFractionDigits]="2"
              [maxFractionDigits]="2"
              [style]="{ width: '100%' }"
            ></p-inputNumber>

            <small class="field-hint" *ngIf="productoSeleccionado">
              Precio original: S/ {{ productoSeleccionado.pre_unit | number:'1.2-2' }}
            </small>
          </div>

          <div class="col-12" *ngIf="precioRemate > 0 && productoSeleccionado">
            <div class="descuento-card">
              <div class="descuento-info">
                <i class="pi pi-info-circle"></i>
                <div>
                  <strong>Descuento aplicado:</strong>
                  <span class="descuento-valor">{{ calcularPorcentajeDescuento() }}% de descuento</span>
                </div>
              </div>

              <div class="descuento-detalle">
                <div class="descuento-item">
                  <span class="descuento-label">Precio original:</span>
                  <span class="descuento-precio original">
                    S/ {{ productoSeleccionado.pre_unit | number:'1.2-2' }}
                  </span>
                </div>
                <div class="descuento-item">
                  <span class="descuento-label">Precio de remate:</span>
                  <span class="descuento-precio remate">S/ {{ precioRemate | number:'1.2-2' }}</span>
                </div>
                <div class="descuento-item">
                  <span class="descuento-label">Ahorro por unidad:</span>
                  <span class="descuento-precio ahorro">
                    S/ {{ (productoSeleccionado.pre_unit - precioRemate) | number:'1.2-2' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </p-card>
    </div>

    <!-- Resumen Final -->
    <div class="col-12" *ngIf="tipoRegistro && productoSeleccionado && motivo">
      <p-card styleClass="resumen-card">
        <h3 class="resumen-title">Resumen del Registro</h3>

        <div class="resumen-grid">
          <div class="resumen-item">
            <span class="resumen-label">Tipo:</span>
            <span class="resumen-value">
              <span [class]="'badge badge-' + tipoRegistro">
                {{ tipoRegistro === 'merma' ? 'MERMA' : 'REMATE' }}
              </span>
            </span>
          </div>

          <div class="resumen-item">
            <span class="resumen-label">Producto:</span>
            <span class="resumen-value">{{ productoSeleccionado.anexo }}</span>
          </div>

          <div class="resumen-item">
            <span class="resumen-label">Cantidad:</span>
            <span class="resumen-value">{{ cantidad }} unidades</span>
          </div>

          <div class="resumen-item">
            <span class="resumen-label">Motivo:</span>
            <span class="resumen-value">{{ getMotivoLabel(motivo) }}</span>
          </div>

          <div class="resumen-item" *ngIf="tipoRegistro === 'remate'">
            <span class="resumen-label">Código de remate:</span>
            <span class="resumen-value codigo-remate">{{ codigoRemate }}</span>
          </div>

          <div class="resumen-item" *ngIf="tipoRegistro === 'remate'">
            <span class="resumen-label">Precio de remate:</span>
            <span class="resumen-value precio-remate">S/ {{ precioRemate | number:'1.2-2' }}</span>
          </div>

          <div class="resumen-item">
            <span class="resumen-label">Responsable:</span>
            <span class="resumen-value">{{ responsableNombre }}</span>
          </div>
        </div>
      </p-card>
    </div>

    <!-- Botones de Acción -->
    <div class="col-12">
      <p-card styleClass="actions-card">
        <div class="flex justify-content-center gap-3">
          <p-button
            label="Cancelar"
            icon="pi pi-times"
            [outlined]="true"
            severity="secondary"
            styleClass="action-btn-cancel"
            (onClick)="cancelar()"
          ></p-button>

          <p-button
            label="Registrar"
            icon="pi pi-check"
            styleClass="action-btn-submit"
            (onClick)="registrar()"
          ></p-button>
        </div>
      </p-card>
    </div>
  </div>

  <p-toast />
</div>