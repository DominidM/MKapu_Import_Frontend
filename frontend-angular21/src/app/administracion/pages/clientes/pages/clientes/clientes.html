<div class="clientes-page">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <p-card styleClass="clientes-header-card mb-3">
    <div class="flex align-items-center justify-content-between flex-wrap gap-3">
      <div class="flex align-items-center gap-3">
        <span class="clientes-title-icon"><i class="pi pi-users"></i></span>
        <div>
          <p class="clientes-kicker">VENTAS - CLIENTES</p>
          <h2 class="clientes-title">GESTIÓN DE CLIENTES</h2>
        </div>
      </div>

      <div class="flex justify-items-end gap-2">
        <p-button
          label="Agregar Cliente"
          icon="pi pi-plus"
          styleClass="clientes-pill"
          [routerLink]="['/admin/clientes/agregar-cliente']"
        ></p-button>
      </div>
    </div>
  </p-card>

  <p-card>
    <div class="flex flex-column lg:flex-row lg:align-items-center lg:justify-content-between gap-3">
      <div class="clientes-search-container flex-1">
        <span class="clientes-search-label">Buscar Cliente</span>

        <p-autoComplete
          class="clientes-search-input"
          [ngModel]="autoTerm()"
          (ngModelChange)="onAutoChange($event)"
          [suggestions]="suggestions()"
          field="displayName"
          (completeMethod)="onAutoComplete($event)"
          (onSelect)="onSelectCliente($event)"
          (keydown.enter)="confirmAutoSearch()"
          placeholder="DNI, RUC, nombre o razón social..."
          [inputStyle]="{ width: '100%' }"
          style="background: transparent;"
        >
          <ng-template let-item pTemplate="item">
            <div class="flex flex-column gap-1">
              <span class="font-medium">{{ item.displayName }}</span>
              <small class="text-500">{{ getDocTypeLabel(item.documentTypeSunatCode) }}: {{ item.documentValue }}</small>
            </div>
          </ng-template>
        </p-autoComplete>
      </div>

      <div class="flex align-items-center gap-2 clientes-filter-actions">
        <p-select
          [options]="viewOptions"
          optionLabel="label"
          optionValue="value"
          [ngModel]="viewMode()"
          (ngModelChange)="onViewModeChange($event)"
          placeholder="Todos"
          class="clientes-filter-select"
        ></p-select>

        <p-button
          label="Limpiar Filtros"
          icon="pi pi-filter-slash"
          severity="danger"
          styleClass="clientes-pill"
          type="button"
          (click)="clearSearch()"
        ></p-button>
      </div>
    </div>
  </p-card>

  <div class="mb-3">
    <p-message *ngIf="loading()" severity="info" text="Cargando clientes..."></p-message>
    <p-message *ngIf="!loading() && error() as e" severity="error" [text]="e"></p-message>
  </div>

  <p-card>
    <div class="flex align-items-center justify-content-between mb-3">
      <div class="flex align-items-center gap-2">
        <span class="clientes-section-icon"><i class="pi pi-user"></i></span>
        <span class="text-sm font-semibold">
          {{
            viewMode() === 'juridica'
              ? 'CLIENTES JURÍDICOS'
              : viewMode() === 'natural'
                ? 'CLIENTES NATURALES'
                : 'CLIENTES (TODOS)'
          }}
        </span>

        <p-tag
          [value]="'[' + displayedList().length + '] Clientes'"
          [severity]="viewMode() === 'juridica' ? 'info' : viewMode() === 'natural' ? 'warn' : 'info'"
        ></p-tag>
      </div>
    </div>

    <div *ngIf="displayedList().length === 0" class="sedes-empty-state">
      <div class="sedes-empty-icon">
        <i class="pi pi-search"></i>
      </div>
      <div class="sedes-empty-title">No hay clientes con ese filtro</div>
      <div class="sedes-empty-subtitle">
        Prueba con otro término o limpia los filtros para ver todos los clientes.
      </div>
      <p-button
        label="Limpiar filtros"
        icon="pi pi-filter-slash"
        severity="danger"
        styleClass="sedes-pill sedes-pill-danger"
        type="button"
        (click)="clearSearch()"
      ></p-button>
    </div>

    <p-table
      *ngIf="displayedList().length > 0"
      [value]="displayedList()"
      [paginator]="true"
      [rows]="rows()"
      [rowsPerPageOptions]="[5,10,20]"
      [tableStyle]="{ 'min-width': '60rem' }"
      styleClass="p-datatable-sm p-datatable-striped clientes-table"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>Documento</th>
          <th>Tipo Doc.</th>
          <th>Cliente / Razón Social</th>
          <th>Teléfono</th>
          <th>Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-cliente>
        <tr>
          <td><span class="doc-value">{{ cliente.documentValue }}</span></td>
          <td><p-tag [value]="getDocTypeLabel(cliente.documentTypeSunatCode)" severity="secondary" class="doc-tag"></p-tag></td>
          <td>
            <div class="flex align-items-center gap-3">
              <i [class]="isCompany(cliente.documentTypeSunatCode, cliente.businessName) ? 'pi pi-building' : 'pi pi-user'"></i>
              <div class="flex flex-column">
                <span class="display-name">{{ getDisplayName(cliente) }}</span>
                <small class="type-label">{{ getCustomerTypeLabel(cliente) }}</small>
              </div>
            </div>
          </td>
          <td><span class="phone-value">{{ getPhoneDisplay(cliente) }}</span></td>
          <td>
            <div class="flex align-items-center gap-2">
              <button pButton type="button" icon="pi pi-eye" class="p-button-text" (click)="openDetails(cliente)"></button>
              <a [routerLink]="['editar-cliente', cliente.customerId]" pButton type="button" icon="pi pi-pencil" class="p-button-text"></a>

              <!-- Toggle status (activate/deactivate) -->
              <button
                pButton
                type="button"
                class="p-button-text"
                (click)="confirmToggleStatus(cliente)"
                [attr.title]="cliente.status ? 'Desactivar cliente' : 'Activar cliente'"
                [icon]="cliente.status ? 'pi pi-times' : 'pi pi-check'"
                [ngStyle]="{ color: cliente.status ? '#ff5252' : '#38a169' }"
              ></button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>

    <!-- DIALOG: detalles del cliente -->
    <p-dialog
    [visible]="showDetails()"
    [modal]="true"
    [closable]="false"
    [style]="{ width: '480px', 'border-radius': '16px', overflow: 'hidden' }"
    [contentStyle]="{ padding: '0' }"
    (onHide)="closeDetails()">

    <ng-template pTemplate="header">
        <span></span>
    </ng-template>

    <ng-container *ngIf="selectedClient() as c">
        <div class="cliente-detail-modal">

        <!-- TOP BANNER -->
        <div class="cdm-banner" [class.cdm-banner--empresa]="isCompany(c.documentTypeSunatCode, c.businessName)">
            <div class="cdm-banner-icon">
            <i [class]="isCompany(c.documentTypeSunatCode, c.businessName) ? 'pi pi-building' : 'pi pi-user'"></i>
            </div>
            <div class="cdm-banner-info">
            <span class="cdm-tipo">{{ getCustomerTypeLabel(c) }}</span>
            <h3 class="cdm-nombre">{{ getDisplayName(c) }}</h3>
            </div>
            <button class="cdm-close-btn" (click)="closeDetails()">
            <i class="pi pi-times"></i>
            </button>
        </div>

        <!-- DOC BADGE -->
        <div class="cdm-doc-row">
            <span class="cdm-doc-badge">
            <i class="pi pi-id-card"></i>
            {{ getDocTypeLabel(c.documentTypeSunatCode) }}
            </span>
            <span class="cdm-doc-value">{{ c.documentValue }}</span>
            <span class="cdm-status-badge" [class.cdm-status--active]="c.status" [class.cdm-status--inactive]="!c.status">
            <span class="cdm-status-dot"></span>
            {{ c.status ? 'Activo' : 'Inactivo' }}
            </span>
        </div>

        <!-- INFO GRID -->
        <div class="cdm-info-grid">

            <div class="cdm-info-item" *ngIf="c.phone">
            <span class="cdm-info-icon"><i class="pi pi-phone"></i></span>
            <div class="cdm-info-content">
                <span class="cdm-info-label">Teléfono</span>
                <span class="cdm-info-value">{{ c.phone }}</span>
            </div>
            </div>

            <div class="cdm-info-item" *ngIf="c.email">
            <span class="cdm-info-icon"><i class="pi pi-envelope"></i></span>
            <div class="cdm-info-content">
                <span class="cdm-info-label">Email</span>
                <span class="cdm-info-value">{{ c.email }}</span>
            </div>
            </div>

            <div class="cdm-info-item cdm-info-item--full" *ngIf="c.address">
            <span class="cdm-info-icon"><i class="pi pi-map-marker"></i></span>
            <div class="cdm-info-content">
                <span class="cdm-info-label">Dirección</span>
                <span class="cdm-info-value">{{ c.address }}</span>
            </div>
            </div>

            <!-- Sin datos -->
            <div class="cdm-empty" *ngIf="!c.phone && !c.email && !c.address">
            <i class="pi pi-info-circle"></i>
            <span>Sin información de contacto registrada</span>
            </div>

        </div>

        <!-- FOOTER -->
        <div class="cdm-footer">
            <p-button
            label="Cerrar"
            icon="pi pi-times"
            severity="secondary"
            [outlined]="true"
            styleClass="cdm-btn-close"
            (onClick)="closeDetails()">
            </p-button>
            <p-button
            label="Editar Cliente"
            icon="pi pi-pencil"
            styleClass="cdm-btn-edit"
            [routerLink]="['editar-cliente', c.customerId]"
            (onClick)="closeDetails()">
            </p-button>
        </div>

        </div>
    </ng-container>
    </p-dialog>

    <p-confirmDialog />
  </p-card>
</div>