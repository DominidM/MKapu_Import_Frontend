<div class="p-2">
  <p-card styleClass="productos-header-card mb-4 productos-header-bordered">
    <div class="flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="flex align-items-center gap-3">
        <span class="productos-title-icon">
          <i [class]="iconoCabecera()"></i>
        </span>
        <div>
          <p class="productos-kicker mb-0">{{ tituloKicker() }}</p>
          <h2 class="productos-title mb-0">{{ tituloPrincipal() }}</h2>
        </div>
      </div>
      <div class="flex gap-2">
        <p-button icon="pi pi-arrow-left" (onClick)="cancelar()" [outlined]="true" severity="secondary"
          styleClass="productos-pill productos-pill-secondary" pTooltip="Volver a productos activos">
        </p-button>
      </div>
    </div>
  </p-card>
</div>

<div class="p-2 surface-card border-1 border-300 border-round-xl shadow-2">
  <form [formGroup]="productoForm" (ngSubmit)="guardarProducto()" class="formgrid grid p-4">

    <div class="col-12 mb-3">
      <h3 class="text-xl font-bold text-900 m-0 flex align-items-center gap-2">
        <i class="pi pi-info-circle text-warning"></i>
        Información Básica
      </h3>
    </div>

    <div class="field col-12 md:col-6 mb-4">
      <label for="codigo" class="font-semibold text-900 mb-2 block">Código *</label>
      <input pInputText id="codigo" formControlName="codigo" class="w-full border-1 border-300 uppercase"
        placeholder="Ej: RAF-TV55, RAF-LG32" />
      @if (productoForm.get('codigo')?.invalid && productoForm.get('codigo')?.touched) {
      <small class="text-red-500 block mt-2">El código es requerido</small>
      }
    </div>

    <div class="field col-12 md:col-6 mb-4">
      <label for="anexo" class="font-semibold text-900 mb-2 block">Nombre *</label>
      <input pInputText id="anexo" formControlName="anexo" class="w-full border-1 border-300 uppercase"
        placeholder="Ej: Smart TV LED 55 pulgadas 4K RAF..." />
      @if (productoForm.get('anexo')?.invalid && productoForm.get('anexo')?.touched) {
      <small class="text-red-500 block mt-2">El nombre es requerido</small>
      }
    </div>

    <div class="field col-12 mb-4">
      <label for="descripcion" class="font-semibold text-900 mb-2 block">Descripción</label>
      <textarea id="descripcion" formControlName="descripcion" rows="3"
        class="w-full border-1 border-300 p-3 border-round uppercase" style="resize: vertical; font-family: inherit"
        placeholder="Descripción detallada del producto (opcional)"></textarea>
    </div>

    <div class="col-12 mb-3">
      <div class="border-top-1 border-300"></div>
    </div>

    <div class="col-12 mb-3">
      <h3 class="text-xl font-bold text-900 m-0 flex align-items-center gap-2">
        <i class="pi pi-tag text-warning"></i>
        Categoría
      </h3>
    </div>

    <div class="field col-12 md:col-6 mb-4">
      <label for="familia" class="font-semibold text-900 mb-2 block">Familia *</label>
      <p-select id="familia" formControlName="familia" [options]="categorias()" optionLabel="nombre"
        optionValue="id_categoria" placeholder="Seleccionar familia" styleClass="w-full border-1 border-300"></p-select>
      @if (productoForm.get('familia')?.invalid && productoForm.get('familia')?.touched) {
      <small class="text-red-500 block mt-2">La familia es requerida</small>
      }
    </div>

    <div class="field col-12 md:col-6 mb-4">
      <label for="unidadMedida" class="font-semibold text-900 mb-2 block">Unidad de Medida *</label>
      <input pInputText formControlName="unidadMedida" class="w-full border-1 border-300 uppercase"
        placeholder="Ej: UND" />
      @if (productoForm.get('unidadMedida')?.invalid && productoForm.get('unidadMedida')?.touched) {
      <small class="text-red-500 block mt-2">La unidad de medida es requerida</small>
      }
    </div>

    <div class="col-12 mb-3">
      <div class="border-top-1 border-300"></div>
    </div>

    <div class="col-12 mb-3">
      <h3 class="text-xl font-bold text-900 m-0 flex align-items-center gap-2">
        <i class="pi pi-dollar text-warning"></i>
        Precios
      </h3>
    </div>

    <div class="field col-12 md:col-6 lg:col-4 mb-4">
      <label class="font-semibold text-900 mb-2 block">Precio Compra (S/) *</label>
      <p-inputNumber formControlName="precioCompra" mode="currency" currency="PEN" locale="es-PE" styleClass="w-full"
        [min]="0" placeholder="S/ 0.00"></p-inputNumber>
    </div>

    <div class="field col-12 md:col-6 lg:col-4 mb-4">
      <label class="font-semibold text-900 mb-2 block">Precio Venta (S/) *</label>
      <p-inputNumber formControlName="precioVenta" mode="currency" currency="PEN" locale="es-PE" styleClass="w-full"
        [min]="0" placeholder="S/ 0.00"></p-inputNumber>
    </div>

    <div class="field col-12 md:col-6 lg:col-4 mb-4">
      <label class="font-semibold text-900 mb-2 block">Precio Unidad (S/) *</label>
      <p-inputNumber formControlName="precioUnidad" mode="currency" currency="PEN" locale="es-PE" styleClass="w-full"
        [min]="0" placeholder="S/ 0.00"></p-inputNumber>
    </div>

    <div class="field col-12 md:col-6 mb-4">
      <label class="font-semibold text-900 mb-2 block">Precio Caja (S/) *</label>
      <p-inputNumber formControlName="precioCaja" mode="currency" currency="PEN" locale="es-PE" styleClass="w-full"
        [min]="0" placeholder="S/ 0.00"></p-inputNumber>
    </div>

    <div class="field col-12 md:col-6 mb-4">
      <label class="font-semibold text-900 mb-2 block">Precio Mayorista (S/) *</label>
      <p-inputNumber formControlName="precioMayorista" mode="currency" currency="PEN" locale="es-PE" styleClass="w-full"
        [min]="0" placeholder="S/ 0.00"></p-inputNumber>
    </div>

    <div class="col-12 mb-3">
      <div class="border-top-1 border-300"></div>
    </div>


    <div class="col-12 mb-3">
      <h3 class="text-xl font-bold text-900 m-0 flex align-items-center gap-2">
        <i class="pi pi-tag text-warning"></i>
        Almacen
      </h3>
    </div>

    <div class="field col-12 mb-4">
      <label for="familia" class="font-semibold text-900 mb-2 block">Almacen *</label>
      <p-select id="almacen" formControlName="almacen" [options]="almacenes()" optionLabel="nombre"
        optionValue="id_almacen" placeholder="Seleccionar almacén" styleClass="w-full border-1 border-300">
      </p-select>

      @if (productoForm.get('almacen')?.invalid && productoForm.get('almacen')?.touched) {
      <small class="text-red-500 block mt-2">El almacén es requerido</small>
      }
    </div>


    <div class="col-12 mb-3">
      <h3 class="text-xl font-bold text-900 m-0 flex align-items-center gap-2">
        <i class="pi pi-warehouse text-warning"></i>
        {{ esModoEdicion() ? 'Gestión de Stock' : 'Stock Inicial' }}
      </h3>
      <p class="text-500 mt-2 text-sm">
        {{ esModoEdicion() ? 'Añade unidades al stock actual (deja en 0 si no deseas agregar).' : 'El producto ingresará
        con esta cantidad a la sede indicada.' }}
      </p>
    </div>

    <div class="field col-12 md:col-4 mb-4">
      <label class="font-semibold text-900 mb-2 block">Sede *</label>
      <p-select formControlName="sede" [options]="sedes()" optionLabel="nombre" optionValue="id_sede"
        placeholder="Seleccionar sede" styleClass="w-full border-1 border-300">
      </p-select>
    </div>

    <div class="field col-12 md:col-4 mb-4">
      <label class="font-semibold text-900 mb-2 block">
        {{ esModoEdicion() ? 'Cantidad a Agregar' : 'Cantidad Inicial' }} *
      </label>
      <p-inputNumber formControlName="stockInicial" [showButtons]="true" buttonLayout="horizontal"
        incrementButtonIcon="pi pi-plus" decrementButtonIcon="pi pi-minus" [min]="0" styleClass="w-full">
      </p-inputNumber>
    </div>

    @if (esModoEdicion()) {
    <div class="field col-12 md:col-4 mb-4">
      <label class="font-semibold text-900 mb-2 block">Stock Total Resultante</label>
      <div
        class="flex align-items-center h-3rem bg-yellow-50 border-round px-3 font-bold text-xl border-1 border-yellow-200 text-800">
        <i class="pi pi-box mr-2 text-warning"></i>
         <span class="text-warning ml-2">{{ stockActual() }} + {{ stockAgregado() }} = </span><span class="text-warning ml-2">{{ stockTotal() }}</span>
      </div>
    </div>
    }

    <div class="field col-12 flex gap-3 justify-content-end pt-3">
      <p-button type="button" label="Cancelar" severity="secondary" [outlined]="true" icon="pi pi-times"
        styleClass="w-10rem" (onClick)="cancelar()"></p-button>

      <p-button type="submit" [disabled]="productoForm.invalid" [label]="esModoEdicion() ? 'Actualizar' : 'Guardar'"
        [icon]="isSubmitting() ? 'pi pi-spin pi-spinner' : 'pi pi-check'" [disabled]="isSubmitting()"
        styleClass="productos-pill productos-pill-warning w-10rem"></p-button>
    </div>

  </form>
</div>

<p-toast></p-toast>
<p-confirmdialog [baseZIndex]="10000"></p-confirmdialog>