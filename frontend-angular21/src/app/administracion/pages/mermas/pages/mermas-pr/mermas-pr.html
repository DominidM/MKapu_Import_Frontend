<div class="clientes-page">
  <p-card styleClass="clientes-header-card">
    <div class="flex align-items-center justify-content-between flex-wrap gap-3">
      <div class="flex align-items-center gap-3">
        <span class="clientes-title-icon">
          <i class="pi pi-exclamation-triangle"></i>
        </span>
        <div>
          <p class="clientes-kicker">ADMINISTRADOR · ADMINISTRACIÓN - MERMAS</p>
          <h2 class="clientes-title">GESTIÓN DE MERMAS</h2>
        </div>
      </div>
      <div class="flex align-items-center gap-2">
        <!-- Navegación vía método (compatible con p-button) -->
        <p-button (onClick)="irRegistro()" label="Registrar Merma"
                  icon="pi pi-plus" styleClass="clientes-pill"></p-button>
      </div>
    </div>
  </p-card>

  <!-- Métricas -->
  <div class="grid mb-4 mermas-metrics">
    <div class="col-12 md:col-4">
      <p-card styleClass="stat-card">
        <div class="stat-card-content">
          <i class="pi pi-exclamation-triangle stat-icon"></i>
          <div>
            <p class="stat-label">TOTAL MERMAS</p>
            <h3 class="stat-value">{{ totalMermas() }}</h3>
            <p class="stat-change">Productos dados de baja</p>
          </div>
        </div>
      </p-card>
    </div>

    <div class="col-12 md:col-4">
      <p-card styleClass="stat-card">
        <div class="stat-card-content">
          <i class="pi pi-box stat-icon"></i>
          <div>
            <p class="stat-label">TOTAL PRODUCTOS</p>
            <h3 class="stat-value">{{ totalProductos() }}</h3>
            <p class="stat-change">Productos afectados</p>
          </div>
        </div>
      </p-card>
    </div>

    <div class="col-12 md:col-4">
      <p-card styleClass="stat-card">
        <div class="stat-card-content">
          <i class="pi pi-calendar stat-icon"></i>
          <div>
            <p class="stat-label">ESTE MES</p>
            <h3 class="stat-value">{{ mermasMesActual() }}</h3>
            <p class="stat-change">Registros en {{ mesActual() }}</p>
          </div>
        </div>
      </p-card>
    </div>
  </div>

  <!-- Filtros de Búsqueda -->
  <p-card styleClass="filtros-card">
    <div class="grid">
      <div class="col-12 md:col-6">
        <label class="filter-label">Buscar Merma</label>
        <span class="p-input-icon-left">
          <input pInputText type="text" placeholder="Buscar por código, motivo o responsable..."
                 class="w-full"
                 [ngModel]="busqueda()"
                 (ngModelChange)="busqueda.set($event)" />
        </span>
      </div>

      <div class="col-12 md:col-3">
        <label class="filter-label">Tipo de Merma</label>
        <p-select [options]="tiposMerma"
                  [ngModel]="tipoMermaFiltro()"
                  (ngModelChange)="tipoMermaFiltro.set($event)"
                  placeholder="Todos los tipos"
                  styleClass="w-full"
                  [showClear]="true">
        </p-select>
      </div>

      <div class="col-12 md:col-3">
        <label class="filter-label" style="visibility: hidden;">Acción</label>
        <p-button label="Limpiar Filtros" icon="pi pi-filter-slash" [outlined]="true"
                  severity="danger" styleClass="w-full" (onClick)="limpiarFiltros()">
        </p-button>
      </div>
    </div>
  </p-card>

  <!-- Tabla de Mermas -->
  <p-card styleClass="tabla-card">
    <div class="flex align-items-center justify-content-between mb-3">
      <div class="flex align-items-center gap-2">
        <span class="tabla-icon">
          <i class="pi pi-table"></i>
        </span>
        <h3 class="tabla-title mb-0">MERMAS REGISTRADAS</h3>
        <p-tag *ngIf="mermasFiltradas().length > 0"
               [value]="mermasFiltradas().length + ' registros'" severity="warn">
        </p-tag>
      </div>
    </div>

    <p-table
      [value]="mermasFiltradas()"
      [tableStyle]="{ 'min-width': '100%' }"
      styleClass="mermas-table"
      [paginator]="true"
      [rows]="5"
      [rowsPerPageOptions]="[5, 10, 20, 50]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} mermas"
      [loading]="cargando()">
      
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 10%">CÓDIGO</th>
          <th style="width: 30%">MOTIVO</th>
          <th style="width: 12%">TIPO MERMA</th>
          <th style="width: 10%">CANTIDAD</th>
          <th style="width: 15%">RESPONSABLE</th>
          <th style="width: 13%">FECHA</th>
          <th style="width: 10%" class="text-center">ACCIONES</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-merma>
        <tr>
          <td><span class="codigo-producto">{{ merma.codigo }}</span></td>
          <td>
            <div class="producto-info">
              <div class="producto-nombre">{{ merma.motivo }}</div>
              <div class="producto-responsable text-sm text-500">
                {{ merma.observacion || 'Sin observaciones' }}
              </div>
            </div>
          </td>
          <td>
            <p-tag [value]="getTipoMermaLabel(merma.tipoMerma)"
                   [severity]="getTipoMermaSeverity(merma.tipoMerma)">
            </p-tag>
          </td>
          <td><span class="cantidad-badge">{{ merma.cantidad }} unid.</span></td>
          <td><span class="text-700">{{ merma.responsable }}</span></td>
          <td><div class="fecha-producto">{{ merma.fechaRegistro | date:'dd/MM/yyyy HH:mm' }}</div></td>
          <td class="text-center">
            <p-button icon="pi pi-eye" [text]="true" severity="info" styleClass="action-btn"
                      (onClick)="verDetalleMerma(merma)" pTooltip="Ver detalle" tooltipPosition="left">
            </p-button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center py-5">
            <i class="pi pi-inbox text-4xl text-400 mb-3"></i>
            <p class="text-500 mt-2">No hay mermas registradas con los filtros seleccionados.</p>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <p-dialog
    [visible]="mostrarModalDetalle()"
    (onHide)="cerrarModalDetalle()"
    [modal]="true"
    [draggable]="false"
    [style]="{ width: '700px', 'border-radius': '16px', overflow: 'hidden' }"
    [contentStyle]="{ padding: '0' }"
    styleClass="mermas-dialog">

    <ng-template pTemplate="header"><span></span></ng-template>

    <ng-container *ngIf="mermaSeleccionada() as ms">
      <div class="merma-detail-modal">

        <!-- BANNER -->
        <div class="mdm-banner">
          <div class="mdm-banner-icon">
            <i class="pi pi-exclamation-triangle"></i>
          </div>
          <div class="mdm-banner-info">
            <span class="mdm-kicker">MERMA</span>
            <h3 class="mdm-nombre">{{ ms.codigo }}</h3>
          </div>
          <button class="mdm-close-btn" (click)="cerrarModalDetalle()">
            <i class="pi pi-times"></i>
          </button>
        </div>

        <!-- TIPO + CANTIDAD -->
        <div class="mdm-code-row">
          <span class="mdm-code-badge">
            <i class="pi pi-tag"></i>
            {{ getTipoMermaLabel(ms.tipoMerma) }}
          </span>
          <span class="mdm-cantidad-badge">
            <i class="pi pi-box"></i>
            {{ ms.cantidad }} unidades
          </span>
        </div>

        <!-- INFO GRID -->
        <div class="mdm-info-grid">

          <div class="mdm-info-item mdm-info-item--full">
            <span class="mdm-info-icon"><i class="pi pi-comment"></i></span>
            <div class="mdm-info-content">
              <span class="mdm-info-label">Motivo</span>
              <span class="mdm-info-value">{{ ms.motivo }}</span>
            </div>
          </div>

          <div class="mdm-info-item">
            <span class="mdm-info-icon"><i class="pi pi-user"></i></span>
            <div class="mdm-info-content">
              <span class="mdm-info-label">Responsable</span>
              <span class="mdm-info-value">{{ ms.responsable }}</span>
            </div>
          </div>

          <div class="mdm-info-item">
            <span class="mdm-info-icon"><i class="pi pi-calendar"></i></span>
            <div class="mdm-info-content">
              <span class="mdm-info-label">Fecha</span>
              <span class="mdm-info-value">{{ ms.fechaRegistro | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
          </div>

          <div class="mdm-info-item mdm-info-item--full" *ngIf="ms.observacion">
            <span class="mdm-info-icon"><i class="pi pi-info-circle"></i></span>
            <div class="mdm-info-content">
              <span class="mdm-info-label">Observaciones</span>
              <span class="mdm-info-value">{{ ms.observacion }}</span>
            </div>
          </div>

        </div>

        <!-- TABLA PRODUCTOS -->
        <div class="mdm-productos" *ngIf="ms.detalles && ms.detalles.length > 0">
          <div class="mdm-productos-header">
            <i class="pi pi-box"></i>
            <span>PRODUCTOS AFECTADOS</span>
            <span class="mdm-productos-count">{{ ms.detalles.length }}</span>
          </div>
          <p-table [value]="ms.detalles" styleClass="p-datatable-sm mdm-table">
            <ng-template pTemplate="header">
              <tr>
                <th>Código</th>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio Unit.</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-detalle>
              <tr>
                <td>{{ detalle.cod_prod }}</td>
                <td>{{ detalle.desc_prod }}</td>
                <td>{{ detalle.cantidad }}</td>
                <td>S/ {{ detalle.pre_unit | number: '1.2-2' }}</td>
              </tr>
            </ng-template>
          </p-table>
        </div>

        <!-- FOOTER -->
        <div class="mdm-footer">
          <p-button
            label="Cerrar"
            icon="pi pi-times"
            severity="secondary"
            [outlined]="true"
            styleClass="mdm-btn-close"
            (onClick)="cerrarModalDetalle()">
          </p-button>
        </div>

      </div>
    </ng-container>
  </p-dialog>

  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>
  
</div>