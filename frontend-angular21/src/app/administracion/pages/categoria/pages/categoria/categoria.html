<div class="sedes-page">
  <p-card styleClass="sedes-header-card">
    <div class="flex align-items-center justify-content-between flex-wrap gap-3">
      <div class="flex align-items-center gap-3">
        <span class="sedes-title-icon">
          <i class="pi pi-tag"></i>
        </span>
        <div>
          <p class="sedes-kicker">ADMINISTRADOR - ADMINISTRACIÓN - CATEGORÍAS</p>
          <h2 class="sedes-title">GESTIÓN DE CATEGORÍAS</h2>
        </div>
      </div>
      <div class="flex justify-items-end gap-2">
        <p-button
          label="Agregar Categoría"
          icon="pi pi-plus"
          styleClass="sedes-pill"
          [routerLink]="['/admin/categoria/agregar-categoria']"
        ></p-button>
      </div>
    </div>
  </p-card>

  <p-card>
    <div class="flex flex-column lg:flex-row lg:align-items-center lg:justify-content-between gap-3">
      <div class="sedes-search-container flex-1">
        <span class="sedes-search-label">Buscar Categoría</span>
        <p-autoComplete
          class="sedes-search-input"
          [ngModel]="searchTerm()"
          (ngModelChange)="onSearchChange($event)"
          [suggestions]="categoriaSuggestions()"
          field="nombre"
          (completeMethod)="onSearch($event)"
          (onSelect)="onSelectCategoria($event)"
          placeholder="Escribe nombre o descripción..."
          style="background: transparent; color: var(--text-color);"
          [inputStyle]="{ width: '100%', background: 'transparent', color: 'var(--text-color)' }"
        >
          <ng-template let-item pTemplate="item">
            <div class="flex flex-column gap-1">
              <span class="font-medium">{{ item.nombre }}</span>
              <small class="text-500">{{ item.descripcion }}</small>
            </div>
          </ng-template>
        </p-autoComplete>
      </div>

      <div class="flex align-items-center gap-2 sedes-filter-actions">
        <p-select
          [options]="viewOptions"
          optionLabel="label"
          optionValue="value"
          [ngModel]="viewMode()"
          (ngModelChange)="onViewModeChange($event)"
          placeholder="Todos"
          class="sedes-filter-select"
        ></p-select>
        <p-button
          label="Limpiar Filtros"
          icon="pi pi-filter-slash"
          severity="danger"
          styleClass="sedes-pill sedes-pill-danger"
          type="button"
          (click)="clearSearch()"
        ></p-button>
      </div>
    </div>
  </p-card>

  <p-toast position="top-right" />

  <div class="mb-3">
    <p-message *ngIf="loading()" severity="info" text="Cargando categorías..."></p-message>
    <p-message *ngIf="!loading() && error() as e" severity="error" [text]="e"></p-message>
  </div>

  <p-card>
    <div class="flex align-items-center justify-content-between mb-3">
      <div class="flex align-items-center gap-2">
        <span class="sedes-section-icon">
          <i class="pi pi-tag"></i>
        </span>
        <span class="text-sm font-semibold text-700">
          {{
            viewMode() === 'activas'
              ? 'CATEGORÍAS ACTIVAS'
              : viewMode() === 'inactivas'
                ? 'CATEGORÍAS INACTIVAS'
                : 'CATEGORÍAS (TODAS)'
          }}
        </span>
        <p-tag
          class="sedes-count-tag"
          [value]="'[' + filteredCategorias().length + '] Categorías'"
          [severity]="viewMode() === 'activas' ? 'success' : viewMode() === 'inactivas' ? 'danger' : 'info'"
        ></p-tag>
      </div>
    </div>

    <div *ngIf="filteredCategorias().length === 0" class="sedes-empty-state">
      <div class="sedes-empty-icon"><i class="pi pi-search"></i></div>
      <div class="sedes-empty-title">No hay categorías con ese filtro</div>
      <div class="sedes-empty-subtitle">
        Prueba con otro término o limpia los filtros para ver todas las categorías.
      </div>
      <p-button
        label="Limpiar filtros"
        icon="pi pi-filter-slash"
        severity="danger"
        styleClass="sedes-pill sedes-pill-danger"
        type="button"
        (click)="clearSearch()"
      ></p-button>
    </div>

    <p-table
      *ngIf="filteredCategorias().length > 0"
      [value]="filteredCategorias()"
      styleClass="sedes-table"
      [paginator]="true"
      [rows]="5"
      [rowsPerPageOptions]="[5,10,20,50]"
      [tableStyle]="{ 'min-width': '100%' }"
    >
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 60%">NOMBRE</th>
          <th style="width: 20%">ESTADO</th>
          <th style="width: 20%">ACCIONES</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-cat>
        <tr>
          <td>{{ cat.nombre }}</td>
          <td>
            <p-tag
              [value]="cat.activo ? 'Activo' : 'Inactivo'"
              [severity]="cat.activo ? 'success' : 'danger'"
            ></p-tag>
          </td>
          <td>
            <div class="flex align-items-center gap-2">
              <p-button
                icon="pi pi-eye"
                text
                severity="secondary"
                styleClass="sedes-icon-btn"
                (click)="verDetalle(cat)"
                title="Ver detalle"
              ></p-button>
              <p-button
                icon="pi pi-pencil"
                text
                severity="secondary"
                styleClass="sedes-icon-btn"
                [routerLink]="['/admin/categoria/editar-categoria', cat.id_categoria]"
                title="Editar"
              ></p-button>
              <p-button
                [icon]="cat.activo ? 'pi pi-times' : 'pi pi-check'"
                text
                [severity]="cat.activo ? 'danger' : 'success'"
                styleClass="sedes-icon-btn"
                (click)="confirmToggleStatus(cat)"
                [title]="cat.activo ? 'Desactivar' : 'Activar'"
              ></p-button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>

    <p-confirmdialog />
  </p-card>

  <p-dialog
    [(visible)]="dialogVisible"
    [modal]="true"
    [draggable]="false"
    [style]="{ width: '420px', 'border-radius': '16px', overflow: 'hidden' }"
    [contentStyle]="{ padding: '0' }"
    (onHide)="dialogVisible = false"
  >
    <ng-template pTemplate="header"><span></span></ng-template>

    <ng-container *ngIf="categoriaSeleccionada() as c">
      <div class="almacen-detail-modal">

        <div class="adm-banner">
          <div class="adm-banner-icon">
            <i class="pi pi-tag"></i>
          </div>
          <div class="adm-banner-info">
            <span class="adm-kicker">CATEGORÍA</span>
            <h3 class="adm-nombre">{{ c.nombre }}</h3>
          </div>
          <button class="adm-close-btn" (click)="dialogVisible = false">
            <i class="pi pi-times"></i>
          </button>
        </div>

        <div class="adm-code-row">
          <span class="adm-code-badge">
            <i class="pi pi-hashtag"></i> ID: {{ c.id_categoria }}
          </span>
          <span class="adm-status-badge"
            [class.adm-status--active]="c.activo"
            [class.adm-status--inactive]="!c.activo">
            <span class="adm-status-dot"></span>
            {{ c.activo ? 'Activo' : 'Inactivo' }}
          </span>
        </div>

        <div class="adm-info-grid">

          <div class="adm-info-item adm-info-item--full">
            <span class="adm-info-icon"><i class="pi pi-tag"></i></span>
            <div class="adm-info-content">
              <span class="adm-info-label">Nombre</span>
              <span class="adm-info-value">{{ c.nombre }}</span>
            </div>
          </div>

          <div class="adm-info-item adm-info-item--full">
            <span class="adm-info-icon"><i class="pi pi-align-left"></i></span>
            <div class="adm-info-content">
              <span class="adm-info-label">Descripción</span>
              <span class="adm-info-value">{{ c.descripcion ?? '—' }}</span>
            </div>
          </div>

        </div>

        <div class="adm-footer">
          <p-button
            label="Cerrar"
            icon="pi pi-times"
            severity="secondary"
            [outlined]="true"
            styleClass="adm-btn-close"
            (onClick)="dialogVisible = false">
          </p-button>
          <p-button
            label="Editar"
            icon="pi pi-pencil"
            styleClass="adm-btn-edit"
            [routerLink]="['/admin/categoria/editar-categoria', c.id_categoria]"
            (onClick)="dialogVisible = false">
          </p-button>
        </div>

      </div>
    </ng-container>
  </p-dialog>
</div>