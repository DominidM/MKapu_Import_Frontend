<div class="sedes-page">
  <p-card styleClass="sedes-header-card">
    <div class="flex align-items-center justify-content-between flex-wrap gap-3">
      <div class="flex align-items-center gap-3">
        <span class="sedes-title-icon">
          <i class="pi pi-list"></i>
        </span>
        <div>
          <p class="sedes-kicker"> ALMACÉN - ALMACÉN</p>
          <h2 class="sedes-title">GESTIÓN DE ALMACÉN</h2>
        </div>
      </div>
      <div class="flex justify-items-end gap-2">
        <p-button
          label="Agregar Almacén"
          icon="pi pi-plus"
          styleClass="sedes-pill"
          [routerLink]="['/admin/almacen/crear-almacen']"
        ></p-button>
      </div>
    </div>
  </p-card>

  <p-card>
    <div class="flex flex-column lg:flex-row lg:align-items-center lg:justify-content-between gap-3">
      <div class="sedes-search-container flex-1">
        <span class="sedes-search-label">Buscar Almacén</span>
        <p-autoComplete
          class="sedes-search-input"
          [ngModel]="searchTerm()"
          (ngModelChange)="onSearchChange($event)"
          [suggestions]="almacenSuggestions()"
          field="nombre"
          (completeMethod)="onSearch($event)"
          (onSelect)="onSelectAlmacen($event)"
          placeholder="Escribe código, nombre, departamento o ciudad..."
          style="background: transparent; color: var(--text-color);"
          [inputStyle]="{ width: '100%', background: 'transparent', color: 'var(--text-color)' }"
        >
          <ng-template let-item pTemplate="item">
            <div class="flex flex-column gap-1">
              <span class="font-medium">{{ item.nombre }}</span>
              <small class="text-500">{{ item.codigo }}</small>
            </div>
          </ng-template>
        </p-autoComplete>
      </div>

      <div class="flex align-items-center gap-2 sedes-filter-actions">
        <p-select
          [options]="viewOptions"
          optionLabel="label"
          optionValue="value"
          [ngModel]="viewMode()"
          (ngModelChange)="onViewModeChange($event)"
          placeholder="Todos"
          class="sedes-filter-select"
        ></p-select>
        <p-button
          label="Limpiar Filtros"
          icon="pi pi-filter-slash"
          severity="danger"
          styleClass="sedes-pill sedes-pill-danger"
          type="button"
          (click)="clearSearch()"
        ></p-button>
      </div>
    </div>
  </p-card>

  <p-toast position="top-right" />

  <div class="mb-3">
    <p-message *ngIf="loading()" severity="info" text="Cargando almacenes..."></p-message>
    <p-message *ngIf="!loading() && error() as e" severity="error" [text]="e"></p-message>
  </div>

  <p-card>
    <div class="flex align-items-center justify-content-between mb-3">
      <div class="flex align-items-center gap-2">
        <span class="sedes-section-icon">
          <i class="pi pi-warehouse"></i>
        </span>
        <span class="text-sm font-semibold text-700">
          {{
            viewMode() === 'activas'
              ? 'ALMACENES ACTIVOS'
              : viewMode() === 'inactivas'
                ? 'ALMACENES INACTIVOS'
                : 'ALMACENES (TODAS)'
          }}
        </span>
        <p-tag
          class="sedes-count-tag"
          [value]="'[' + filteredAlmacenes().length + '] Almacenes'"
          [severity]="viewMode() === 'activas' ? 'success' : viewMode() === 'inactivas' ? 'danger' : 'info'"
        ></p-tag>
      </div>
      <p-button icon="pi pi-id-card" text severity="secondary" styleClass="sedes-icon-btn"></p-button>
    </div>

    <div *ngIf="filteredAlmacenes().length === 0" class="sedes-empty-state">
      <div class="sedes-empty-icon"><i class="pi pi-search"></i></div>
      <div class="sedes-empty-title">No hay almacenes con ese filtro</div>
      <div class="sedes-empty-subtitle">
        Prueba con otro término o limpia los filtros para ver todos los almacenes.
      </div>
      <p-button
        label="Limpiar filtros"
        icon="pi pi-filter-slash"
        severity="danger"
        styleClass="sedes-pill sedes-pill-danger"
        type="button"
        (click)="clearSearch()"
      ></p-button>
    </div>

    <p-table
      *ngIf="filteredAlmacenes().length > 0"
      [value]="filteredAlmacenes()"
      styleClass="sedes-table"
      [paginator]="true"
      [rows]="5"
      [rowsPerPageOptions]="[5,10,20,50]"
      [tableStyle]="{ 'min-width': '60rem' }"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>CODIGO</th>
          <th>NOMBRE</th>
          <th>UBICACIÓN</th>
          <th>TELÉFONO</th>
          <th>ESTADO</th>
          <th>ACCIONES</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-almacen>
        <tr>
          <td>{{ almacen.codigo }}</td>
          <td>{{ almacen.nombre }}</td>
          <td>
            <span class="inline-flex align-items-center gap-2">
              <i class="pi pi-map-marker text-500"></i>
              {{ (almacen.departamento ? almacen.departamento : '') 
                  + (almacen.provincia ? ' · ' + almacen.provincia : '') 
                  + (almacen.ciudad ? ' · ' + almacen.ciudad : '') }}
            </span>
          </td>
          <td>
            <span class="inline-flex align-items-center gap-2">
              <i class="pi pi-phone text-500"></i>
              {{ almacen.telefono }}
            </span>
          </td>
          <td>
            <p-tag
              [value]="almacen.activo ? 'Activo' : 'Inactivo'"
              [severity]="almacen.activo ? 'success' : 'danger'"
            ></p-tag>
          </td>
          <td>
            <div class="flex align-items-center gap-2">

            <p-button
              icon="pi pi-eye"
              text
              severity="secondary"
              styleClass="sedes-icon-btn"
              (click)="verDetalle(almacen)"
              title="Ver detalle"
            ></p-button>

              <p-button
                icon="pi pi-pencil"
                text
                severity="secondary"
                styleClass="sedes-icon-btn sedes-action-edit"
                [routerLink]="['/admin/almacen/editar-almacen', (almacen.id_almacen ?? almacen.id)]"
                [disabled]="!(almacen.id_almacen ?? almacen.id)"
                [title]="(almacen.id_almacen ?? almacen.id) ? 'Editar' : 'ID no disponible'"
              ></p-button>

              <p-button
                [icon]="almacen.activo ? 'pi pi-times' : 'pi pi-check'"
                text
                [severity]="almacen.activo ? 'danger' : 'success'"
                styleClass="sedes-icon-btn sedes-action-status"
                (click)="confirmToggleStatus(almacen)"
                [title]="almacen.activo ? 'Desactivar almacén' : 'Activar almacén'"
              ></p-button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>

    <p-confirmdialog />
  </p-card>

  <p-dialog
    [(visible)]="dialogVisible"
    [modal]="true"
    [draggable]="false"
    [style]="{ width: '480px', 'border-radius': '16px', overflow: 'hidden' }"
    [contentStyle]="{ padding: '0' }"
    (onHide)="dialogVisible = false"
  >
    <ng-template pTemplate="header"><span></span></ng-template>

    <ng-container *ngIf="almacenSeleccionado() as a">
      <div class="almacen-detail-modal">

        <!-- BANNER -->
        <div class="adm-banner">
          <div class="adm-banner-icon">
            <i class="pi pi-warehouse"></i>
          </div>
          <div class="adm-banner-info">
            <span class="adm-kicker">ALMACÉN</span>
            <h3 class="adm-nombre">{{ a.nombre }}</h3>
          </div>
          <button class="adm-close-btn" (click)="dialogVisible = false">
            <i class="pi pi-times"></i>
          </button>
        </div>

        <!-- CÓDIGO + ESTADO -->
        <div class="adm-code-row">
          <span class="adm-code-badge">
            <i class="pi pi-tag"></i>{{ a.codigo }}
          </span>
          <span class="adm-code-value">{{ a.codigo }}</span>
          <span class="adm-status-badge" [class.adm-status--active]="a.activo" [class.adm-status--inactive]="!a.activo">
            <span class="adm-status-dot"></span>
            {{ a.activo ? 'Activo' : 'Inactivo' }}
          </span>
        </div>

        <!-- INFO GRID -->
        <div class="adm-info-grid">

          <div class="adm-info-item">
            <span class="adm-info-icon"><i class="pi pi-map"></i></span>
            <div class="adm-info-content">
              <span class="adm-info-label">Departamento</span>
              <span class="adm-info-value">{{ a.departamento ?? '—' }}</span>
            </div>
          </div>

          <div class="adm-info-item">
            <span class="adm-info-icon"><i class="pi pi-map"></i></span>
            <div class="adm-info-content">
              <span class="adm-info-label">Provincia</span>
              <span class="adm-info-value">{{ a.provincia ?? '—' }}</span>
            </div>
          </div>

          <div class="adm-info-item">
            <span class="adm-info-icon"><i class="pi pi-map-marker"></i></span>
            <div class="adm-info-content">
              <span class="adm-info-label">Ciudad</span>
              <span class="adm-info-value">{{ a.ciudad ?? '—' }}</span>
            </div>
          </div>

          <div class="adm-info-item">
            <span class="adm-info-icon"><i class="pi pi-phone"></i></span>
            <div class="adm-info-content">
              <span class="adm-info-label">Teléfono</span>
              <span class="adm-info-value">{{ a.telefono ?? '—' }}</span>
            </div>
          </div>

          <div class="adm-info-item adm-info-item--full">
            <span class="adm-info-icon"><i class="pi pi-home"></i></span>
            <div class="adm-info-content">
              <span class="adm-info-label">Dirección</span>
              <span class="adm-info-value">{{ a.direccion ?? '—' }}</span>
            </div>
          </div>

        </div>

        <!-- FOOTER -->
        <div class="adm-footer">
          <p-button
            label="Cerrar"
            icon="pi pi-times"
            severity="secondary"
            [outlined]="true"
            styleClass="adm-btn-close"
            (onClick)="dialogVisible = false">
          </p-button>
          <p-button
            label="Editar Almacén"
            icon="pi pi-pencil"
            styleClass="adm-btn-edit"
            [routerLink]="['/admin/almacen/editar-almacen', (a.id_almacen ?? a.id)]"
            (onClick)="dialogVisible = false">
          </p-button>
        </div>

      </div>
    </ng-container>
  </p-dialog>
</div>